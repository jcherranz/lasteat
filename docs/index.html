<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<title>Last Eat — Restaurantes en Madrid</title>
<meta name="description" content="Descubre los mejores restaurantes de Madrid. 770+ restaurantes con valoraciones, precios y ubicaciones. Filtra por cocina, zona y precio.">
<link rel="canonical" href="https://lasteat.es/">
<link rel="preload" href="data.js" as="script">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Last Eat — Restaurantes en Madrid">
<meta property="og:description" content="Descubre los mejores restaurantes de Madrid. 770+ restaurantes con valoraciones, precios y ubicaciones.">
<meta property="og:url" content="https://lasteat.es/">
<meta property="og:site_name" content="Last Eat">
<meta property="og:image" content="https://lasteat.es/og.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Last Eat — Restaurantes en Madrid">
<meta name="twitter:description" content="Descubre los mejores restaurantes de Madrid. 770+ restaurantes con valoraciones, precios y ubicaciones.">
<meta name="twitter:image" content="https://lasteat.es/og.png">

<!-- Favicon -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="icon" href="/icons/icon-192.png" type="image/png">

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2E6058">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

<link rel="preload" href="fonts/cormorant-garamond-300-latin.woff2" as="font" type="font/woff2" crossorigin>
<link rel="preload" href="fonts/dm-sans-400-latin.woff2" as="font" type="font/woff2" crossorigin>

<!-- Prefetch map resources for faster first switch -->
<link rel="prefetch" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="prefetch" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
<link rel="prefetch" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js">

<style>
  @font-face {
    font-family: 'Cormorant Garamond';
    font-style: normal;
    font-weight: 300;
    font-display: swap;
    src: url('fonts/cormorant-garamond-300-latin-ext.woff2') format('woff2');
    unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
  @font-face {
    font-family: 'Cormorant Garamond';
    font-style: normal;
    font-weight: 300;
    font-display: swap;
    src: url('fonts/cormorant-garamond-300-latin.woff2') format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }
  @font-face {
    font-family: 'Cormorant Garamond';
    font-style: normal;
    font-weight: 600;
    font-display: swap;
    src: url('fonts/cormorant-garamond-600-latin-ext.woff2') format('woff2');
    unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
  @font-face {
    font-family: 'Cormorant Garamond';
    font-style: normal;
    font-weight: 600;
    font-display: swap;
    src: url('fonts/cormorant-garamond-600-latin.woff2') format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }
  @font-face {
    font-family: 'DM Sans';
    font-style: normal;
    font-weight: 300;
    font-display: swap;
    src: url('fonts/dm-sans-300-latin-ext.woff2') format('woff2');
    unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
  @font-face {
    font-family: 'DM Sans';
    font-style: normal;
    font-weight: 300;
    font-display: swap;
    src: url('fonts/dm-sans-300-latin.woff2') format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }
  @font-face {
    font-family: 'DM Sans';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url('fonts/dm-sans-400-latin-ext.woff2') format('woff2');
    unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
  @font-face {
    font-family: 'DM Sans';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url('fonts/dm-sans-400-latin.woff2') format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }
  @font-face {
    font-family: 'DM Sans';
    font-style: normal;
    font-weight: 500;
    font-display: swap;
    src: url('fonts/dm-sans-500-latin-ext.woff2') format('woff2');
    unicode-range: U+0100-02BA, U+02BD-02C5, U+02C7-02CC, U+02CE-02D7, U+02DD-02FF, U+0304, U+0308, U+0329, U+1D00-1DBF, U+1E00-1E9F, U+1EF2-1EFF, U+2020, U+20A0-20AB, U+20AD-20C0, U+2113, U+2C60-2C7F, U+A720-A7FF;
  }
  @font-face {
    font-family: 'DM Sans';
    font-style: normal;
    font-weight: 500;
    font-display: swap;
    src: url('fonts/dm-sans-500-latin.woff2') format('woff2');
    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  /* ── Theme Variables ── */
  :root {
    --bg: #F8F7F3;
    --surface: #FFFFFF;
    --text: #1A1D1B;
    --secondary: #5A5F5C;
    --muted: #878C89;
    --accent: #2E6058;
    --accent-soft: rgba(46, 96, 88, 0.06);
    --accent-muted: rgba(46, 96, 88, 0.14);
    --warm: #C4956A;
    --border: #E5E2DC;
    --radius: 2px;
    --text-xs: 0.65rem;
    --text-sm: 0.72rem;
    --text-base: 0.85rem;
    --text-lg: 0.95rem;
    --text-xl: 1.6rem;
    --text-title: 1.35rem;
  }
  [data-theme="dark"] {
    --bg: #0F1311;
    --surface: #181C1A;
    --text: #E4E6E4;
    --secondary: #9EA3A0;
    --muted: #8A8F8C;
    --accent: #4CB0A1;
    --accent-soft: rgba(76, 176, 161, 0.08);
    --accent-muted: rgba(76, 176, 161, 0.15);
    --warm: #D4A574;
    --border: #262A28;
  }

  /* ── Base ── */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ── Accessibility ── */
  .skip-link {
    position: absolute;
    left: 1rem;
    top: -40px;
    padding: 0.5rem 0.8rem;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: var(--text-sm);
    text-decoration: none;
    z-index: 400;
  }
  .skip-link:focus { top: 1rem; }
  .sr-only {
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
    white-space: nowrap;
  }
  a:focus-visible,
  button:focus-visible,
  input:focus-visible,
  select:focus-visible,
  .card:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* ── Masthead ── */
  header {
    padding: 1.5rem 2rem 0;
    text-align: center;
    position: relative;
  }
  .logo {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 2.8rem;
    font-weight: 600;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    line-height: 1;
    color: var(--text);
  }
  .theme-toggle {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    background: none;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: var(--text-base);
    color: var(--muted);
    width: 44px;
    height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: color 0.25s;
    line-height: 1;
  }
  .theme-toggle::before { content: '\2600'; }
  [data-theme="dark"] .theme-toggle::before { content: '\263D'; }
  .theme-toggle:hover { color: var(--accent); }

  /* ── Controls ── */
  .controls-wrap {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
    transition: box-shadow 0.3s;
  }
  .controls-wrap.scrolled {
    box-shadow: 0 2px 16px rgba(0,0,0,0.06);
  }
  [data-theme="dark"] .controls-wrap.scrolled {
    box-shadow: 0 2px 16px rgba(0,0,0,0.25);
  }
  .controls {
    max-width: 1140px;
    margin: 0 auto;
    padding: 0.75rem 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  /* ── Search ── */
  .search-wrap {
    position: relative;
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0;
  }
  .search-wrap::before {
    content: '';
    position: absolute;
    left: 0.6rem;
    top: 50%;
    transform: translateY(-50%);
    width: 14px;
    height: 14px;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='none' stroke='%23878C89' stroke-width='1.5' stroke-linecap='round'%3E%3Ccircle cx='6' cy='6' r='4.5'/%3E%3Cline x1='9.5' y1='9.5' x2='13' y2='13'/%3E%3C/svg%3E") no-repeat center;
    opacity: 0.65;
    pointer-events: none;
  }
  .search-box {
    flex: 1;
    min-width: 0;
    padding: 0.3rem 2rem 0.3rem 1.8rem;
    min-height: 32px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: var(--text-sm);
    font-family: inherit;
    font-weight: 400;
    letter-spacing: 0.01em;
    background: transparent;
    outline: none;
    color: var(--text);
    transition: border-color 0.2s;
  }
  .search-box::placeholder { color: var(--muted); font-weight: 300; }
  .search-box:focus { border-color: var(--accent); }
  .search-clear {
    position: absolute;
    right: 0.2rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 1.1rem;
    color: var(--muted);
    cursor: pointer;
    padding: 0.3rem 0.4rem;
    line-height: 1;
    transition: color 0.2s;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .search-clear:hover { color: var(--accent); }

  /* ── Controls Layout ── */
  .controls-row-1 {
    flex-basis: 100%;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.15rem;
  }
  .controls-row-1 .search-wrap { flex: 1; margin-bottom: 0; }
  .controls-row-2 {
    flex-basis: 100%;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    position: relative;
  }

  /* ── View Toggle & Fav ── */
  .view-toggle {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    flex-shrink: 0;
  }
  .view-link {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.3rem 0.65rem;
    font-size: var(--text-xs);
    font-family: inherit;
    letter-spacing: 0.03em;
    color: var(--secondary);
    cursor: pointer;
    white-space: nowrap;
    min-height: 32px;
    display: inline-flex;
    align-items: center;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
  }
  .view-link:hover { border-color: var(--secondary); color: var(--text); }
  .view-link.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  [data-theme="dark"] .view-link.active { color: #0F1311; }

  /* ── Filter Pills (shared by price, cuisine, district) ── */
  .filter-pill {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.3rem 0.65rem;
    font-size: var(--text-xs);
    font-family: inherit;
    letter-spacing: 0.03em;
    color: var(--secondary);
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.2s, border-color 0.2s, background 0.2s;
    min-height: 32px;
    display: inline-flex;
    align-items: center;
  }
  .filter-pill:hover { border-color: var(--secondary); color: var(--text); }
  .filter-pill.active {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  [data-theme="dark"] .filter-pill.active { color: #0F1311; }
  .filter-pill.dimmed { opacity: 0.4; }

  /* ── Filter Group ── */
  .filter-group {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.3rem;
    flex-basis: 100%;
  }
  .filter-group-label {
    font-size: var(--text-xs);
    color: var(--muted);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    user-select: none;
    width: 3.2rem;
    flex-shrink: 0;
  }
  .filter-group .ms-trigger {
    background: none;
    background-image: none;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.3rem 0.65rem;
    font-size: var(--text-xs);
    letter-spacing: 0.03em;
    min-height: 32px;
  }
  [data-theme="dark"] .filter-group .ms-trigger { background-image: none; }
  .filter-group .ms-trigger:hover { border-color: var(--secondary); color: var(--text); }
  .filter-group .ms.open .ms-trigger {
    border-color: var(--accent);
    color: var(--accent);
  }
  .filter-group .ms.has-sel .ms-trigger {
    border-color: var(--accent);
    color: var(--accent);
    font-weight: 400;
  }

  /* ── Sort Dropdown ── */
  .sort-wrap {
    position: absolute;
    top: 0;
    right: 0;
  }
  .sort-trigger {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.3rem 0.65rem;
    font-size: var(--text-xs);
    font-family: inherit;
    font-weight: 400;
    letter-spacing: 0.03em;
    color: var(--secondary);
    cursor: pointer;
    white-space: nowrap;
    min-height: 32px;
    display: inline-flex;
    align-items: center;
    transition: color 0.2s, border-color 0.2s;
  }
  .sort-trigger:hover { border-color: var(--secondary); color: var(--text); }
  .sort-wrap.open .sort-trigger {
    border-color: var(--accent);
    color: var(--accent);
  }
  .sort-drop {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    min-width: 160px;
    z-index: 200;
    overflow: hidden;
  }
  .sort-wrap.open .sort-drop {
    display: block;
    animation: dropIn 0.2s ease;
  }
  .sort-option {
    display: block;
    width: 100%;
    padding: 0.5rem 0.85rem;
    min-height: 44px;
    border: none;
    background: transparent;
    color: var(--secondary);
    font: 400 var(--text-sm) / 1 inherit;
    cursor: pointer;
    text-align: left;
    transition: background 0.15s, color 0.15s;
    letter-spacing: 0.02em;
  }
  .sort-option:hover { background: var(--accent-soft); color: var(--text); }
  .sort-option.active {
    color: var(--accent);
    font-weight: 500;
    background: var(--accent-soft);
  }

  /* ── Active Filters ── */
  .active-filters {
    max-width: 1140px;
    margin: 0 auto;
    padding: 0 2rem 0.5rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }
  .active-filters:empty { display: none; }
  .active-filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.2rem 0.5rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: var(--text-xs);
    color: var(--secondary);
    background: var(--surface);
    line-height: 1.4;
  }
  .tag-dismiss {
    background: none;
    border: none;
    font-size: 0.75rem;
    color: var(--muted);
    cursor: pointer;
    padding: 0.5rem;
    margin: -0.5rem;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    transition: color 0.2s;
  }
  .tag-dismiss:hover { color: var(--accent); }

  /* ── Surprise Prompt ── */
  .surprise-prompt {
    max-width: 1140px;
    margin: 0 auto;
    text-align: center;
    padding: 3rem 2rem;
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: var(--text-xl);
    font-weight: 300;
    color: var(--muted);
  }
  .surprise-prompt button {
    font-family: inherit;
    font-size: inherit;
    font-weight: 600;
    color: var(--accent);
    background: none;
    border: none;
    border-bottom: 1px solid var(--accent-muted);
    cursor: pointer;
    transition: border-color 0.2s;
    padding: 0;
    margin-left: 0.3em;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
  }
  .surprise-prompt button:hover { border-bottom-color: var(--accent); }

  /* ── Multi-select ── */
  .ms { position: relative; }
  .ms-trigger {
    padding: 0.4rem 1.2rem 0.4rem 0;
    border: none;
    border-bottom: 1.5px solid transparent;
    background: none;
    font-size: var(--text-sm);
    font-family: inherit;
    font-weight: 400;
    letter-spacing: 0.02em;
    color: var(--secondary);
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.2s, border-color 0.2s;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%23878C89'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0 center;
  }
  .ms-trigger:hover { color: var(--text); border-bottom-color: var(--border); }
  [data-theme="dark"] .ms-trigger {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%238A8F8C'/%3E%3C/svg%3E");
  }
  .ms.open .ms-trigger { color: var(--accent); border-bottom-color: var(--accent); }
  .ms.has-sel .ms-trigger {
    color: var(--text);
    font-weight: 500;
    border-bottom-color: var(--border);
  }
  .ms-drop {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    left: 0;
    min-width: 240px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    z-index: 200;
    overflow: hidden;
  }
  .ms.open .ms-drop {
    display: block;
    animation: dropIn 0.2s ease;
  }
  @keyframes dropIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .ms-search {
    width: 100%;
    padding: 0.6rem 0.8rem;
    min-height: 44px;
    border: none;
    border-bottom: 1px solid var(--border);
    font-size: var(--text-sm);
    font-family: inherit;
    outline: none;
    background: transparent;
    color: var(--text);
  }
  .ms-search::placeholder { color: var(--muted); }
  .ms-opts {
    max-height: min(280px, 50vh);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .ms-opts::-webkit-scrollbar { width: 4px; }
  .ms-opts::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .ms-opts label {
    display: flex;
    align-items: center;
    padding: 0.3rem 0.8rem;
    font-size: var(--text-sm);
    color: var(--secondary);
    cursor: pointer;
    transition: background 0.15s;
    gap: 0.5rem;
  }
  .ms-opts label:hover { background: var(--accent-soft); }
  .ms-opts label.active { background: var(--accent-soft); }
  .ms-label { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .ms-count { flex-shrink: 0; color: var(--muted); font-size: var(--text-xs); padding-left: 0.5rem; }
  .ms-opts input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    width: 14px;
    height: 14px;
    border: 1.5px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
    transition: background 0.15s, border-color 0.15s;
  }
  .ms-opts input:checked {
    background: var(--accent);
    border-color: var(--accent);
  }
  .ms-opts input:checked::after {
    content: '';
    position: absolute;
    left: 3.5px;
    top: 0.5px;
    width: 4px;
    height: 7px;
    border: solid #fff;
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg);
  }
  .ms-clear {
    display: none;
    width: 100%;
    min-height: 44px;
    padding: 0.4rem;
    border: none;
    border-top: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-size: var(--text-sm);
    font-family: inherit;
    cursor: pointer;
    transition: color 0.2s;
  }
  .ms.has-sel .ms-clear { display: block; }
  .ms-clear:hover { color: var(--accent); }
  .ms-group-header {
    padding: 0.4rem 0.8rem 0.2rem;
    font-size: var(--text-xs);
    font-weight: 500;
    color: var(--muted);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    border-top: 1px solid var(--border);
  }
  .ms-group-header:first-child { border-top: none; }
  .ms-opts label.zero-count { display: none; }
  .card-dist {
    font-size: var(--text-sm);
    color: var(--secondary);
    font-weight: 500;
    white-space: nowrap;
  }

  /* ── Grid ── */
  .grid {
    max-width: 1140px;
    margin: 1rem auto 0;
    padding: 0 2rem 3rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 0.75rem;
  }

  /* ── Card ── */
  @keyframes cardIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.3rem 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.45rem;
    cursor: pointer;
    transition: border-color 0.25s ease;
    animation: cardIn 0.35s ease both;
  }
  .card.top-rated {
    border-left: 3px solid var(--warm);
    padding-left: calc(1.5rem - 2px);
  }
  .card:hover {
    border-color: var(--muted);
  }
  .card.expanded:not(.top-rated) {
    border-left: 2px solid var(--accent);
    padding-left: calc(1.5rem - 1px);
  }
  .card.reveal {
    opacity: 0;
    animation: none;
    transition: opacity 0.3s ease;
  }
  .card.reveal.in {
    opacity: 1;
  }
  .card-top {
    display: flex;
    align-items: baseline;
    gap: 0.6rem;
  }
  .card-name {
    flex: 1;
    font-size: var(--text-lg);
    font-weight: 600;
    line-height: 1.35;
    min-width: 0;
  }
  .card-name a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s;
  }
  .card-name a:hover { color: var(--accent); }
  .fav-btn {
    background: none;
    border: none;
    padding: 0.35rem;
    cursor: pointer;
    font-size: var(--text-base);
    color: var(--muted);
    transition: color 0.15s, transform 0.15s;
    line-height: 1;
    flex-shrink: 0;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .fav-btn:hover { color: var(--accent); }
  .fav-btn.active { color: var(--accent); }
  .card-rating {
    flex-shrink: 0;
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: var(--text-xl);
    font-weight: 600;
    color: var(--warm);
    line-height: 1;
  }
  .card-rating.no-r {
    color: var(--muted);
    font-size: 1.1rem;
    font-weight: 400;
  }

  .card-meta {
    font-size: var(--text-sm);
    color: var(--muted);
    display: flex;
    flex-wrap: wrap;
    letter-spacing: 0.01em;
  }
  .card-meta span + span::before {
    content: '·';
    margin: 0 0.4rem;
    color: var(--border);
  }

  .card-tags {
    font-size: var(--text-sm);
    color: var(--secondary);
    margin-top: 0.15rem;
    line-height: 1.45;
  }

  .card-actions {
    display: flex;
    gap: 1rem;
    margin-top: auto;
    padding-top: 0.3rem;
  }
  .card-actions a {
    font-size: var(--text-sm);
    color: var(--muted);
    text-decoration: none;
    letter-spacing: 0.02em;
    font-weight: 400;
    transition: color 0.2s;
    display: inline-flex;
    align-items: center;
    min-height: 44px;
  }
  .card-actions a:hover { color: var(--accent); }

  /* ── Card Expand ── */
  .card-expand {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s ease;
  }
  .card.expanded .card-expand { grid-template-rows: 1fr; }
  .card-expand > div { overflow: hidden; }
  .card-detail {
    padding-top: 0.55rem;
    margin-top: 0.15rem;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  .card-ratings {
    font-size: var(--text-sm);
    color: var(--muted);
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
  }
  .card-ratings strong { color: var(--secondary); font-weight: 500; }
  .card-address {
    font-size: var(--text-sm);
    color: var(--muted);
    line-height: 1.45;
  }
  .card-phone a {
    font-size: var(--text-sm);
    color: var(--accent);
    text-decoration: none;
  }
  .card-phone a:hover { text-decoration: underline; }

  .no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: 5rem 2rem;
    color: var(--muted);
    font-size: var(--text-base);
    font-style: italic;
  }
  .no-results p { margin-bottom: 0.75rem; }
  .no-results .clear-filters {
    display: inline-block;
    margin-top: 0.5rem;
    padding: 0.25rem 0;
    border: none;
    border-bottom: 1px solid var(--muted);
    background: transparent;
    color: var(--secondary);
    font-size: var(--text-sm);
    font-family: inherit;
    font-style: normal;
    cursor: pointer;
    transition: color 0.25s, border-color 0.25s;
  }
  .no-results .clear-filters:hover { color: var(--accent); border-bottom-color: var(--accent); }

  /* ── Load More ── */
  .load-more { grid-column: 1 / -1; text-align: center; padding: 2rem 0 0.5rem; }
  .load-more-btn {
    display: inline-block;
    padding: 0.25rem 0;
    border: none;
    border-bottom: 1px solid var(--muted);
    background: transparent;
    color: var(--secondary);
    font-size: var(--text-sm);
    font-family: inherit;
    cursor: pointer;
    transition: color 0.25s, border-color 0.25s;
  }
  .load-more-btn:hover { color: var(--accent); border-bottom-color: var(--accent); }

  .district-header {
    grid-column: 1 / -1;
    font-size: var(--text-sm);
    color: var(--muted);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.8rem 0 0.2rem;
    border-bottom: 1px solid var(--border);
  }
  /* ── Map ── */
  /* ── Map Layout ── */
  #map-container {
    max-width: 1140px;
    margin: 1rem auto 0;
    padding: 0 2rem 3rem;
    gap: 0;
    position: relative;
    flex-wrap: wrap;
    isolation: isolate;
  }
  #map-container:not([hidden]) {
    display: flex;
  }
  .map-head {
    width: 100%;
    padding: 0.55rem 0.2rem;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    color: var(--secondary);
    letter-spacing: 0.04em;
  }
  .map-head-title {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: var(--text-title);
    font-weight: 600;
    color: var(--text);
  }
  .map-head-count {
    font-size: var(--text-sm);
    color: var(--muted);
  }
  #map-panel {
    width: 320px;
    flex-shrink: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-right: none;
    border-radius: var(--radius) 0 0 var(--radius);
    overflow-y: auto;
    max-height: 70vh;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  #map-panel::-webkit-scrollbar { width: 4px; }
  #map-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  #map-panel-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .map-panel-item {
    padding: 0.65rem 0.85rem;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
    font-size: var(--text-base);
    line-height: 1.45;
  }
  .map-panel-item:hover { background: var(--accent-soft); }
  .map-panel-item.active { border-left: 2px solid var(--accent); padding-left: calc(0.85rem - 2px); }
  .map-panel-name {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 600;
    font-size: var(--text-lg);
    color: var(--text);
    display: block;
    margin-bottom: 0.1rem;
  }
  .map-panel-meta {
    color: var(--secondary);
    font-size: var(--text-sm);
  }
  .map-panel-meta .map-panel-rating {
    color: var(--warm);
    font-weight: 500;
  }
  #map-view {
    flex: 1;
    height: 70vh;
    border-radius: 0 var(--radius) var(--radius) 0;
    border: 1px solid var(--border);
    background: var(--surface);
    position: relative;
    min-width: 0;
  }
  /* When panel is hidden (mobile), restore full radius */
  @media (max-width: 768px) {
    #map-panel { display: none; }
    #map-view { border-radius: var(--radius); }
  }

  /* ── Full-Screen Map Mode ── */
  #filter-toggle { display: none; }
  body.map-mode { overflow: hidden; }
  body.map-mode #map-container {
    max-width: none;
    padding: 0;
    margin: 0;
    height: calc(100vh - var(--controls-h, 80px));
    overflow: hidden;
    position: relative;
  }
  body.map-mode #map-container:not([hidden]) { display: block; }
  body.map-mode #map-view {
    height: 100%;
    width: 100%;
    border-radius: 0;
    border: none;
  }
  body.map-mode .map-head,
  body.map-mode #map-panel { display: none; }
  body.map-mode .surprise-prompt,
  body.map-mode .btt,
  body.map-mode footer { display: none; }
  body.map-mode .active-filters { display: none; }

  /* Filtros toggle: visible only in map mode */
  body.map-mode #filter-toggle { display: inline-flex; }

  /* Filter rows hidden in map mode, overlay when open */
  body.map-mode .controls-row-2 { display: none; }
  body.map-mode .controls-row-2.filters-open {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bg);
    padding: 0.75rem 2rem;
    border-bottom: 1px solid var(--border);
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    z-index: 200;
  }
  [data-theme="dark"] body.map-mode .controls-row-2.filters-open {
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }

  /* Filtros button accent fill when filters active */
  #filter-toggle.has-filters {
    background: var(--accent);
    border-color: var(--accent);
    color: #fff;
  }
  [data-theme="dark"] #filter-toggle.has-filters { color: #0F1311; }

  /* Map count badge */
  .map-count-badge {
    display: none;
    position: absolute;
    bottom: 1.5rem;
    left: 1rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.25rem 0.6rem;
    font-size: var(--text-xs);
    color: var(--secondary);
    z-index: 500;
    pointer-events: none;
  }
  body.map-mode .map-count-badge { display: block; }

  /* ── Map Loading State ── */
  #map-view:not(.loaded)::before {
    content: '';
    position: absolute;
    top: calc(50% - 12px);
    left: 50%;
    width: 10px;
    height: 10px;
    margin: -5px 0 0 -5px;
    border-radius: 50%;
    background: var(--accent);
    animation: mapPulse 1.2s ease-in-out infinite;
    z-index: 1;
  }
  #map-view:not(.loaded)::after {
    content: 'Cargando mapa\2026';
    position: absolute;
    top: calc(50% + 10px);
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--text-sm);
    color: var(--muted);
    letter-spacing: 0.04em;
    z-index: 1;
  }
  /* 1.2s intentional for subtle ambient pulse — exempt from 150-300ms guideline */
  @keyframes mapPulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
  }

  /* ── Map Markers (SVG divIcon) ── */
  .map-marker {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s ease;
  }
  .map-marker:hover { transform: scale(1.25); }
  .map-marker svg { filter: drop-shadow(0 1px 3px rgba(0,0,0,0.25)); }

  /* ── Cluster Overrides ── */
  .marker-cluster {
    transition: transform 0.15s ease;
  }
  .marker-cluster:hover { transform: scale(1.1); }
  .marker-cluster-small {
    background: rgba(76, 176, 161, 0.18) !important;
    width: 34px !important; height: 34px !important;
  }
  .marker-cluster-medium {
    background: rgba(76, 176, 161, 0.22) !important;
    width: 40px !important; height: 40px !important;
  }
  .marker-cluster-large {
    background: rgba(76, 176, 161, 0.28) !important;
    width: 48px !important; height: 48px !important;
  }
  .marker-cluster-small div,
  .marker-cluster-medium div,
  .marker-cluster-large div {
    background: var(--accent) !important;
    color: #fff !important;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    margin-top: 0 !important;
    margin-left: 0 !important;
    display: flex !important;
    align-items: center;
    justify-content: center;
  }
  .marker-cluster-small div {
    width: 24px !important; height: 24px !important;
    font-size: var(--text-xs);
  }
  .marker-cluster-medium div {
    width: 30px !important; height: 30px !important;
    font-size: var(--text-sm);
  }
  .marker-cluster-large div {
    width: 36px !important; height: 36px !important;
    font-size: var(--text-base);
  }

  /* ── Rich Popups ── */
  .leaflet-popup-content-wrapper {
    border-radius: var(--radius) !important;
    font-family: 'DM Sans', sans-serif !important;
    box-shadow: none !important;
    background: var(--surface) !important;
    color: var(--text) !important;
  }
  .leaflet-popup-tip { background: var(--surface) !important; }
  .leaflet-popup-content { margin: 0 !important; padding: 0 !important; width: auto !important; }
  .map-popup { padding: 0.75rem 0.85rem; min-width: 180px; max-width: 240px; }
  .map-popup-name {
    font-family: 'Cormorant Garamond', serif;
    font-weight: 600;
    font-size: var(--text-lg);
    line-height: 1.25;
    margin-bottom: 0.3rem;
    color: var(--text);
  }
  .map-popup-rating {
    display: inline-block;
    color: var(--warm);
    font-size: var(--text-sm);
    font-weight: 500;
    margin-bottom: 0.35rem;
  }
  .map-popup-meta {
    font-size: var(--text-sm);
    color: var(--secondary);
    line-height: 1.5;
    margin-bottom: 0.3rem;
  }
  .map-popup-tags {
    font-size: var(--text-sm);
    color: var(--secondary);
    margin-bottom: 0.35rem;
    line-height: 1.45;
  }
  .map-popup-link {
    display: inline-block;
    font-size: var(--text-sm);
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
  }
  .map-popup-link:hover { text-decoration: underline; }

  /* ── Map Tooltips ── */
  .map-tooltip {
    font-family: 'DM Sans', sans-serif !important;
    font-size: var(--text-sm) !important;
    padding: 0.3rem 0.55rem !important;
    border-radius: var(--radius) !important;
    background: var(--surface) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
  }
  .map-tooltip .map-tt-rating {
    color: var(--warm);
    font-weight: 500;
  }
  .map-tooltip::before { border-top-color: var(--border) !important; }
  .district-label {
    background: none !important;
    border: none !important;
    box-shadow: none !important;
    font-family: 'DM Sans', sans-serif !important;
    font-size: var(--text-xs) !important;
    font-weight: 500;
    color: var(--secondary) !important;
    text-shadow: 0 0 3px var(--bg), 0 0 6px var(--bg);
    pointer-events: none !important;
    padding: 0 !important;
  }
  .district-label::before { display: none !important; }

  /* ── Map Attribution ── */
  .leaflet-control-attribution {
    background: transparent !important;
    font-size: var(--text-xs) !important;
    color: var(--muted) !important;
    opacity: 0.5;
    transition: opacity 0.2s;
  }
  .leaflet-control-attribution:hover { opacity: 1; }
  .leaflet-control-attribution a { color: var(--muted) !important; }

  /* ── Leaflet Zoom Controls ── */
  .leaflet-control-zoom {
    border: 1.5px solid var(--border) !important;
    border-radius: var(--radius) !important;
    box-shadow: none !important;
    overflow: hidden;
  }
  .leaflet-control-zoom a {
    background: var(--surface) !important;
    color: var(--muted) !important;
    width: 36px !important;
    height: 36px !important;
    line-height: 36px !important;
    font-size: 1rem !important;
    border-color: var(--border) !important;
    transition: color 0.2s, background 0.2s;
  }
  .leaflet-control-zoom a:hover {
    background: var(--accent-soft) !important;
    color: var(--accent) !important;
  }
  .leaflet-control-zoom-in { border-bottom: 1px solid var(--border) !important; }
  .leaflet-interactive:focus { outline: none; }

  /* ── Back to top ── */
  .btt {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: var(--surface);
    color: var(--muted);
    font-size: var(--text-base);
    cursor: pointer;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s, transform 0.3s, color 0.3s;
    pointer-events: none;
    z-index: 50;
    line-height: 1;
  }
  .btt.visible { opacity: 1; transform: none; pointer-events: auto; }
  .btt:hover { color: var(--accent); }

  /* ── Footer ── */
  footer {
    max-width: 1140px;
    margin: 0 auto;
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--border);
    font-size: var(--text-sm);
    color: var(--muted);
    text-align: center;
    letter-spacing: 0.02em;
  }
  footer a {
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
  }
  footer a:hover { color: var(--accent); }
  .footer-sep { margin: 0 0.4em; }
  @media (max-width: 640px) {
    footer { padding: 1.25rem; font-size: var(--text-xs); }
  }



  /* ── Reduced Motion ── */
  @media (prefers-reduced-motion: reduce) {
    .card { animation: none; }
    .card.reveal { opacity: 1; transition: none; }
    .ms.open .ms-drop, .sort-wrap.open .sort-drop { animation: none; }
    *, *::before, *::after { transition-duration: 0.01ms !important; }
  }

  /* ── Responsive ── */
  @media (max-width: 640px) {
    header { padding: 1.25rem 1.25rem 0; }
    .logo { font-size: 2.2rem; letter-spacing: 0.15em; }
    .theme-toggle { top: 1rem; right: 1rem; }
    .controls { padding: 0.6rem 1rem; gap: 0.35rem; }

    /* Row 1: search on top, pills below */
    .controls-row-1 {
      flex-wrap: wrap;
      gap: 0.35rem;
    }
    .controls-row-1 .search-wrap {
      flex-basis: 100%;
      min-width: 0;
    }

    /* Row 2: tighter layout */
    .controls-row-2 { gap: 0.3rem; }

    /* Filter groups: drop the fixed-width label, stack vertically */
    .filter-group {
      gap: 0.25rem;
    }
    .filter-group-label {
      width: auto;
      margin-right: 0.15rem;
    }

    /* Sort pill: flow normally on mobile */
    .sort-wrap {
      position: static;
    }

    /* Smaller pills on mobile */
    .filter-pill,
    .view-link,
    .filter-group .ms-trigger,
    .sort-trigger {
      padding: 0.25rem 0.5rem;
      min-height: 28px;
    }

    .active-filters { padding: 0 1rem 0.4rem; }
    .grid {
      grid-template-columns: 1fr;
      padding: 0 1rem 2rem;
      gap: 0.6rem;
    }
    .card { padding: 1.1rem 1.2rem; }
    .ms-drop { min-width: 220px; }
    #map-container { padding: 0 1rem 2rem; }
    #map-view { height: 55vh; border-radius: var(--radius); }
    .surprise-prompt { padding: 2rem 1.25rem; font-size: var(--text-title); }

    /* Map mode filter overlay: tighter padding */
    body.map-mode .controls-row-2.filters-open {
      padding: 0.6rem 1rem;
    }
  }
</style>
</head>
<body>

<a href="#grid" class="skip-link">Saltar al contenido</a>

<header>
  <div class="logo">Last Eat</div>
  <button class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema"></button>
</header>

<div class="controls-wrap">
  <div class="controls">
    <div class="controls-row-1">
      <label class="sr-only" for="search">Buscar restaurantes</label>
      <div class="search-wrap">
        <input type="text" class="search-box" id="search" placeholder="Buscar restaurante, cocina, zona...">
        <button class="search-clear" id="search-clear" type="button" aria-label="Limpiar b&uacute;squeda" hidden>&times;</button>
      </div>
      <div class="view-toggle" role="group" aria-label="Modo de vista">
        <button class="view-link active" data-view="grid" type="button">Lista</button>
        <button class="view-link" data-view="map" type="button">Mapa</button>
      </div>
      <button class="view-link" id="filter-toggle" type="button">Filtros &#9662;</button>
      <button class="view-link" id="fav-filter" type="button" aria-pressed="false">&#9825; Favoritos</button>
    </div>

    <div class="controls-row-2">
      <div class="filter-group" id="fg-price">
        <span class="filter-group-label">Precio</span>
        <button class="filter-pill" data-price="0-30" type="button">&le;30 &euro;</button>
        <button class="filter-pill" data-price="31-50" type="button">31&ndash;50 &euro;</button>
        <button class="filter-pill" data-price="51-80" type="button">51&ndash;80 &euro;</button>
        <button class="filter-pill" data-price="80-999" type="button">80 &euro;+</button>
      </div>
      <div class="sort-wrap" id="sort-wrap">
        <button class="sort-trigger" id="sort-trigger" type="button" aria-expanded="false" aria-haspopup="listbox" aria-controls="sort-drop">Ordenar: <span id="sort-label">Ranking</span> &#9662;</button>
        <div class="sort-drop" id="sort-drop" role="listbox" aria-label="Ordenar por">
          <button class="sort-option active" data-sort="rating" role="option" aria-selected="true" type="button">Ranking</button>
          <button class="sort-option" data-sort="name" role="option" aria-selected="false" type="button">A-Z</button>
          <button class="sort-option" data-sort="price" role="option" aria-selected="false" type="button">Precio</button>
          <button class="sort-option" data-sort="distance" role="option" aria-selected="false" type="button" id="sort-dist" hidden>Distancia</button>
        </div>
      </div>

      <div class="filter-group" id="fg-cuisine">
        <span class="filter-group-label">Cocina</span>
        <!-- JS inserts top cuisine pills here -->
        <div class="ms" id="ms-cuisine">
          <button class="ms-trigger" type="button" data-label="M&aacute;s" aria-expanded="false" aria-haspopup="listbox">M&aacute;s &#9662;</button>
          <div class="ms-drop">
            <input class="ms-search" type="text" placeholder="Buscar cocina..." aria-label="Buscar cocina">
            <div class="ms-opts" role="listbox" aria-multiselectable="true"></div>
            <button class="ms-clear" type="button">Limpiar</button>
          </div>
        </div>
      </div>

      <div class="filter-group" id="fg-district">
        <span class="filter-group-label">Zona</span>
        <!-- JS inserts top district pills here -->
        <div class="ms" id="ms-district">
          <button class="ms-trigger" type="button" data-label="M&aacute;s" aria-expanded="false" aria-haspopup="listbox">M&aacute;s &#9662;</button>
          <div class="ms-drop">
            <input class="ms-search" type="text" placeholder="Buscar zona..." aria-label="Buscar zona">
            <div class="ms-opts" role="listbox" aria-multiselectable="true"></div>
            <button class="ms-clear" type="button">Limpiar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="active-filters" id="active-filters" role="region" aria-label="Filtros activos"></div>
</div>

<div class="grid" id="grid" tabindex="-1"></div>

<div id="map-container" hidden>
  <div class="map-head">
    <span class="map-head-title">Explora Madrid</span>
    <span class="map-head-count" id="map-visible-count"></span>
  </div>
  <nav id="map-panel" aria-label="Lista de restaurantes en mapa">
    <ul id="map-panel-list"></ul>
  </nav>
  <div id="map-view"></div>
  <div class="map-count-badge" id="map-count-badge"></div>
</div>

<div class="surprise-prompt" id="surprise-prompt">
  &iquest;No sabes qu&eacute; elegir?
  <button type="button" id="surprise-btn">Sorpr&eacute;ndeme</button>
</div>

<button class="btt" id="btt" aria-label="Volver arriba">&uarr;</button>

<footer id="footer">
  <a href="https://macarfi.com/es/madrid" target="_blank" rel="noopener">Fuente: Macarfi</a>
  <span class="footer-sep">&middot;</span>
  <span id="footer-updated">Actualizado feb 2026</span>
  <span class="footer-sep">&middot;</span>
  <span>Hecho en Madrid</span>
</footer>

<script src="app.js"></script>
<script src="data.js"></script>
<script>
(function() {
  'use strict';

  /* ── Constants ── */
  var BATCH = 9;
  var LEAFLET_CSS_INTEGRITY = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
  var LEAFLET_JS_INTEGRITY = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
  var MC_JS_INTEGRITY = 'sha256-Hk4dIpcqOSb0hZjgyvFOP+cEmDXUKKNE/tT542ZbNQg=';
  var MC_CSS_INTEGRITY = 'sha256-YSWCMtmNZNwqex4CEw1nQhvFub2lmU7vcCKP+XVwwXA=';
  var MC_CSS_BASE_INTEGRITY = 'sha256-YU3qCpj/P06tdPBJGPax0bm6Q1wltfwjsho5TR4+TYc=';
  var MC_BASE = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3';
  var app = window.LastEatApp;
  if (!app) throw new Error('LastEatApp module is required');

  /* ── DOM ── */
  var grid     = document.getElementById('grid');
  var searchEl = document.getElementById('search');
  var bttEl    = document.getElementById('btt');
  var favBtn   = document.getElementById('fav-filter');
  var surpriseBtn = document.getElementById('surprise-btn');
  var mapCont  = document.getElementById('map-container');
  var mapPanel = document.getElementById('map-panel-list');
  var mapVisibleCountEl = document.getElementById('map-visible-count');
  var sortDistBtn = document.getElementById('sort-dist');
  var sortWrap = document.getElementById('sort-wrap');
  var sortTrigger = document.getElementById('sort-trigger');
  var sortDrop = document.getElementById('sort-drop');
  var sortLabel = document.getElementById('sort-label');
  var activeFiltersEl = document.getElementById('active-filters');

  /* ── Data Maps ── */
  var slugSet = new Set();
  var nameToSlug = Object.create(null);
  RESTAURANTS.forEach(function(r) {
    if (r && r.s) slugSet.add(r.s);
    if (r && r.n && r.s && !nameToSlug[r.n]) nameToSlug[r.n] = r.s;
  });

  /* ── State ── */
  var sort       = 'rating';
  var view       = 'grid';
  var favs       = new Set();
  var favsOnly   = false;
  var selCuisine = new Set();
  var selDistrict= new Set();
  var selPrice   = new Set();
  var filtered   = [];
  var rendered   = 0;
  var map          = null;
  var mapFitDone   = false;
  var tileLayer    = null;
  var clusterGroup = null;
  var markerIndex  = [];  /* {marker, data, panelEl} per restaurant */
  var leafletOk    = false;
  var clusterOk    = false;
  var userLat      = null;
  var userLng      = null;
  var userMarker   = null;
  var activePanelSlug = null;
  var lastRenderedDistrict = '';
  var prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  var revealObserver = null;

  /* ── Utilities ── */
  var esc = app.esc;
  var haversine = app.haversine;
  var formatDist = app.formatDist;
  function safeGetStorage(key) {
    try { return localStorage.getItem(key); } catch (_err) { return null; }
  }
  function safeSetStorage(key, value) {
    try { localStorage.setItem(key, value); } catch (_err) {}
  }
  function safeGetJSON(key, fallback) {
    var raw = safeGetStorage(key);
    if (!raw) return fallback;
    try { return JSON.parse(raw); } catch (_err) { return fallback; }
  }
  function safeHttpUrl(url) {
    if (!url || typeof url !== 'string') return '';
    try {
      var parsed = new URL(url, window.location.origin);
      if (parsed.protocol === 'http:' || parsed.protocol === 'https:') return parsed.href;
    } catch (_err) {}
    return '';
  }
  function getFavKey(r) {
    return (r && r.s) ? r.s : (r && r.n ? r.n : '');
  }
  function normalizeFavValue(value) {
    if (typeof value !== 'string' || !value) return '';
    if (slugSet.has(value)) return value;
    return nameToSlug[value] || '';
  }
  function loadFavs() {
    var raw = safeGetJSON('mf-fav', []);
    if (!Array.isArray(raw)) return;
    raw.forEach(function(item) {
      var key = normalizeFavValue(item);
      if (key) favs.add(key);
    });
  }
  function buildFilterTag(type, value, label) {
    return '<span class="active-filter-tag" data-filter-type="' + esc(type) + '" data-filter-value="' + esc(value) + '">' +
      esc(label) + '<button class="tag-dismiss" type="button" aria-label="Quitar filtro ' + esc(label) + '">&times;</button></span>';
  }
  var priceLabels = { '0-30': '\u226430 \u20ac', '31-50': '31\u201350 \u20ac', '51-80': '51\u201380 \u20ac', '80-999': '80 \u20ac+' };
  function updateActiveFilters() {
    var tags = [];
    var q = searchEl.value.trim();
    if (q) tags.push(buildFilterTag('search', q, '\u201c' + q + '\u201d'));
    /* Only show tags for overflow selections (not pill items) */
    selCuisine.forEach(function(c) {
      if (!topCuisineSet.has(c)) tags.push(buildFilterTag('cuisine', c, c));
    });
    selDistrict.forEach(function(d) {
      if (!topDistrictSet.has(d)) tags.push(buildFilterTag('district', d, d));
    });
    /* Price: no tags — pills show state directly */
    activeFiltersEl.innerHTML = tags.join('');
  }
  function ensureRevealObserver() {
    if (prefersReducedMotion || revealObserver || !('IntersectionObserver' in window)) return;
    revealObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (!entry.isIntersecting) return;
        entry.target.classList.add('in');
        revealObserver.unobserve(entry.target);
      });
    }, { threshold: 0.12 });
  }
  function observeReveals() {
    if (!revealObserver) return;
    grid.querySelectorAll('.card.reveal:not(.in)').forEach(function(el) {
      revealObserver.observe(el);
    });
  }

  /* ── Theme ── */
  function initTheme() {
    var saved = safeGetStorage('mf-theme');
    if (saved) { document.documentElement.dataset.theme = saved; return; }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.dataset.theme = 'dark';
    }
  }
  function toggleTheme() {
    var isDark = document.documentElement.dataset.theme === 'dark';
    var t = isDark ? 'light' : 'dark';
    document.documentElement.dataset.theme = t;
    safeSetStorage('mf-theme', t);
    if (map && tileLayer) {
      tileLayer.setUrl(getTileUrl());
      syncDistrictPolygons();
      if (view === 'map') updateMap();
    }
  }
  function getTileUrl() {
    return document.documentElement.dataset.theme === 'dark'
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  }

  /* ── Favorites ── */
  function saveFavs() { safeSetStorage('mf-fav', JSON.stringify(Array.from(favs))); }
  function toggleFav(favKey) {
    if (!favKey) return;
    if (favs.has(favKey)) favs.delete(favKey); else favs.add(favKey);
    saveFavs();
    /* Update visible hearts */
    grid.querySelectorAll('.fav-btn').forEach(function(b) {
      var key = b.getAttribute('data-fav-key');
      var active = favs.has(key);
      b.classList.toggle('active', active);
      b.textContent = active ? '\u2665' : '\u2661';
      b.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
    updateFavBtn();
    if (favsOnly) render();
  }
  function updateFavBtn() {
    var heart = favsOnly ? '\u2665' : '\u2661';
    favBtn.textContent = heart + ' Favoritos' + (favs.size ? ' (' + favs.size + ')' : '');
    favBtn.classList.toggle('active', favsOnly);
    favBtn.setAttribute('aria-pressed', favsOnly ? 'true' : 'false');
  }
  loadFavs();

  /* ── Geolocation ── */
  function computeDistances() {
    if (userLat === null) return;
    RESTAURANTS.forEach(function(r) {
      if (r.lat && r.lng) {
        r._dist = haversine(userLat, userLng, parseFloat(r.lat), parseFloat(r.lng));
      } else {
        r._dist = 99999;
      }
    });
  }

  function activateGeo(callback) {
    if (!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(function(pos) {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      computeDistances();
      sortDistBtn.hidden = false;
      if (callback) callback();
    }, function() {
      /* Geo failed — fall back to rating sort */
      sort = 'rating';
      updateSortUI();
      render();
    }, { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 });
  }

  function deactivateGeo() {
    userLat = null;
    userLng = null;
    RESTAURANTS.forEach(function(r) { delete r._dist; });
    sortDistBtn.hidden = true;
    if (userMarker && map) { userMarker.remove(); userMarker = null; }
    if (sort === 'distance') {
      sort = 'rating';
      updateSortUI();
    }
    render();
  }

  /* ── Multi-Select ── */
  function setupMS(id, items, onChange, counts, config) {
    var el      = document.getElementById(id);
    var trigger = el.querySelector('.ms-trigger');
    var search  = el.querySelector('.ms-search');
    var opts    = el.querySelector('.ms-opts');
    var clear   = el.querySelector('.ms-clear');
    var label   = trigger.getAttribute('data-label');
    var activeLabel = null;
    var listboxId = id + '-listbox';
    var groups  = config && config.groups;
    opts.id = listboxId;
    trigger.setAttribute('aria-controls', listboxId);

    function closeDropdown(focusTrigger) {
      el.classList.remove('open');
      trigger.setAttribute('aria-expanded', 'false');
      if (activeLabel) {
        activeLabel.classList.remove('active');
        activeLabel = null;
      }
      if (focusTrigger) trigger.focus();
    }

    function openDropdown() {
      document.querySelectorAll('.ms.open').forEach(function(m) {
        if (m !== el) {
          m.classList.remove('open');
          var otherTrigger = m.querySelector('.ms-trigger');
          if (otherTrigger) otherTrigger.setAttribute('aria-expanded', 'false');
        }
      });
      el.classList.add('open');
      trigger.setAttribute('aria-expanded', 'true');
      search.focus();
    }

    function visibleLabels() {
      return [].slice.call(opts.querySelectorAll('label')).filter(function(l) { return !l.hidden; });
    }

    function setActiveLabel(nextLabel) {
      if (activeLabel) activeLabel.classList.remove('active');
      activeLabel = nextLabel || null;
      if (activeLabel) activeLabel.classList.add('active');
    }

    function focusByStep(step) {
      var labels = visibleLabels();
      if (!labels.length) return;
      var current = document.activeElement && document.activeElement.closest('label');
      var idx = labels.indexOf(current);
      var nextIdx = idx + step;
      if (idx === -1) nextIdx = step > 0 ? 0 : labels.length - 1;
      if (nextIdx < 0) nextIdx = labels.length - 1;
      if (nextIdx >= labels.length) nextIdx = 0;
      var next = labels[nextIdx].querySelector('input');
      if (next) {
        next.focus();
        setActiveLabel(labels[nextIdx]);
      }
    }

    function appendOption(item) {
      var lbl = document.createElement('label');
      var cb  = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = item;
      lbl.setAttribute('role', 'option');
      lbl.setAttribute('aria-selected', 'false');
      lbl.setAttribute('data-name', item.toLowerCase());
      lbl.appendChild(cb);
      var nameSpan = document.createElement('span');
      nameSpan.className = 'ms-label';
      nameSpan.textContent = item;
      lbl.appendChild(nameSpan);
      var cnt = document.createElement('span');
      cnt.className = 'ms-count';
      cnt.textContent = (counts && counts[item] != null) ? counts[item] : '';
      lbl.appendChild(cnt);
      opts.appendChild(lbl);
      cb.addEventListener('change', function() {
        lbl.setAttribute('aria-selected', cb.checked ? 'true' : 'false');
        sync();
        onChange(getSelected());
      });
    }

    /* Render options — grouped or flat */
    if (groups) {
      groups.forEach(function(group) {
        if (group.label) {
          var header = document.createElement('div');
          header.className = 'ms-group-header';
          header.textContent = group.label;
          header.setAttribute('role', 'presentation');
          opts.appendChild(header);
        }
        var groupItems = group.items.slice().sort(function(a, b) {
          return a.localeCompare(b, 'es');
        });
        groupItems.forEach(appendOption);
      });
    } else {
      /* Sort by count descending, then alphabetical tie-break */
      var sorted = items;
      if (counts) {
        sorted = items.slice().sort(function(a, b) {
          var diff = (counts[b] || 0) - (counts[a] || 0);
          return diff !== 0 ? diff : a.localeCompare(b, 'es');
        });
      }
      sorted.forEach(appendOption);
    }

    function hideGroupHeaders(q) {
      opts.querySelectorAll('.ms-group-header').forEach(function(header) {
        var next = header.nextElementSibling;
        var anyVisible = false;
        while (next && !next.classList.contains('ms-group-header')) {
          if (next.tagName === 'LABEL' && !next.hidden) anyVisible = true;
          next = next.nextElementSibling;
        }
        header.hidden = q ? !anyVisible : false;
      });
    }

    el.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    trigger.addEventListener('click', function(e) {
      e.stopPropagation();
      if (el.classList.contains('open')) closeDropdown(false);
      else openDropdown();
    });

    trigger.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (!el.classList.contains('open')) openDropdown();
        focusByStep(e.key === 'ArrowDown' ? 1 : -1);
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDropdown(true);
      }
    });

    search.addEventListener('input', function() {
      var q = search.value.toLowerCase();
      opts.querySelectorAll('label').forEach(function(l) {
        l.hidden = (l.getAttribute('data-name') || l.textContent.toLowerCase()).indexOf(q) === -1;
      });
      hideGroupHeaders(q);
      setActiveLabel(null);
    });

    search.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDropdown(true);
      }
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        focusByStep(e.key === 'ArrowDown' ? 1 : -1);
      }
    });

    clear.addEventListener('click', function() {
      opts.querySelectorAll('input').forEach(function(cb) {
        cb.checked = false;
        var row = cb.closest('label');
        if (row) row.setAttribute('aria-selected', 'false');
      });
      sync();
      onChange(getSelected());
    });

    opts.addEventListener('focusin', function(e) {
      var row = e.target.closest('label');
      if (row) setActiveLabel(row);
    });

    opts.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDropdown(true);
        return;
      }
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        focusByStep(e.key === 'ArrowDown' ? 1 : -1);
        return;
      }
      if (e.key === 'Enter' && e.target && e.target.matches('input[type=\"checkbox\"]')) {
        e.preventDefault();
        e.target.checked = !e.target.checked;
        sync();
        onChange(getSelected());
      }
    });

    function getSelected() {
      return [].slice.call(opts.querySelectorAll('input:checked')).map(function(cb) { return cb.value; });
    }
    function sync() {
      var sel = getSelected();
      var hasSel = sel.length > 0;
      el.classList.toggle('has-sel', hasSel);
      if (config && config.triggerFormat) {
        trigger.textContent = config.triggerFormat(sel);
      } else {
        trigger.textContent = hasSel ? label + ' (' + sel.length + ')' : label;
      }
    }
    return {
      setSelected: function(vals) {
        var set = new Set(vals);
        opts.querySelectorAll('input').forEach(function(cb) {
          cb.checked = set.has(cb.value);
          var row = cb.closest('label');
          if (row) row.setAttribute('aria-selected', cb.checked ? 'true' : 'false');
        });
        sync();
      },
      getSelected: getSelected,
      close: function() { closeDropdown(false); },
      updateCounts: function(newCounts) {
        opts.querySelectorAll('label').forEach(function(lbl) {
          var cb = lbl.querySelector('input');
          if (!cb) return;
          var count = (newCounts && newCounts[cb.value]) || 0;
          var countEl = lbl.querySelector('.ms-count');
          if (countEl) countEl.textContent = count;
          lbl.classList.toggle('zero-count', count === 0 && !cb.checked);
        });
      }
    };
  }

  /* ── Build options with counts ── */
  var cuisineCounts = Object.create(null);
  var districtCounts = Object.create(null);
  RESTAURANTS.forEach(function(r) {
    if (r.c) r.c.split(/\u2022/).forEach(function(t) {
      var trimmed = t.trim();
      if (trimmed) cuisineCounts[trimmed] = (cuisineCounts[trimmed] || 0) + 1;
    });
    if (r.d) districtCounts[r.d] = (districtCounts[r.d] || 0) + 1;
  });

  /* Cuisine: flat list, sorted by count descending */
  var TOP_PILLS = 4;
  var cuisineOpts = Object.keys(cuisineCounts).sort(function(a,b){ return a.localeCompare(b,'es'); });

  /* Top 4 cuisines by count */
  var topCuisines = Object.keys(cuisineCounts)
    .sort(function(a,b) { return (cuisineCounts[b]||0) - (cuisineCounts[a]||0); })
    .slice(0, TOP_PILLS);
  var topCuisineSet = new Set(topCuisines);

  /* Top 4 districts by count */
  var topDistricts = Object.keys(districtCounts)
    .sort(function(a,b) { return (districtCounts[b]||0) - (districtCounts[a]||0); })
    .slice(0, TOP_PILLS);
  var topDistrictSet = new Set(topDistricts);

  var cuisineMS = setupMS('ms-cuisine', cuisineOpts, function(sel) { selCuisine = new Set(sel); syncPills(); render(); }, cuisineCounts, {
    triggerFormat: function(sel) {
      var overflow = sel.filter(function(s) { return !topCuisineSet.has(s); }).length;
      return overflow > 0 ? 'M\u00e1s (+' + overflow + ') \u25BE' : 'M\u00e1s \u25BE';
    }
  });

  /* District: grouped — Madrid city vs surrounding municipalities */
  var MADRID_DISTRICTS = [
    'Arganzuela','Barajas','Carabanchel','Centro','Chamartín','Chamberí',
    'Ciudad Lineal','Fuencarral-El Pardo','Hortaleza','Latina','Madrid',
    'Madrid - Ciudad','Moncloa-Aravaca','Moratalaz','Puente de Vallecas',
    'Retiro','Salamanca','San Blas-Canillejas','Tetuán','Usera',
    'Vicálvaro','Villa de Vallecas','Villaverde'
  ];
  var madridSet = new Set(MADRID_DISTRICTS);
  var districtMadrid = [];
  var districtComunidad = [];
  Object.keys(districtCounts).forEach(function(d) {
    if (madridSet.has(d)) districtMadrid.push(d);
    else districtComunidad.push(d);
  });
  var districtMS = setupMS('ms-district', [], function(sel) { selDistrict = new Set(sel); syncPills(); syncDistrictPolygons(); render(); }, districtCounts, {
    groups: [
      { label: 'Madrid', items: districtMadrid },
      { label: 'Comunidad de Madrid', items: districtComunidad }
    ],
    triggerFormat: function(sel) {
      var overflow = sel.filter(function(s) { return !topDistrictSet.has(s); }).length;
      return overflow > 0 ? 'M\u00e1s (+' + overflow + ') \u25BE' : 'M\u00e1s \u25BE';
    }
  });

  /* ── Insert top pills into filter groups ── */
  var fgCuisine = document.getElementById('fg-cuisine');
  var msCuisineEl = fgCuisine.querySelector('.ms');
  topCuisines.forEach(function(name) {
    var btn = document.createElement('button');
    btn.className = 'filter-pill';
    btn.type = 'button';
    btn.setAttribute('data-cuisine', name);
    btn.textContent = name;
    fgCuisine.insertBefore(btn, msCuisineEl);
  });

  var fgDistrict = document.getElementById('fg-district');
  var msDistrictEl = fgDistrict.querySelector('.ms');
  topDistricts.forEach(function(name) {
    var btn = document.createElement('button');
    btn.className = 'filter-pill';
    btn.type = 'button';
    btn.setAttribute('data-district', name);
    btn.textContent = name;
    fgDistrict.insertBefore(btn, msDistrictEl);
  });

  /* ── Cuisine pill clicks ── */
  fgCuisine.addEventListener('click', function(e) {
    var btn = e.target.closest('.filter-pill[data-cuisine]');
    if (!btn) return;
    var val = btn.getAttribute('data-cuisine');
    if (selCuisine.has(val)) selCuisine.delete(val);
    else selCuisine.add(val);
    cuisineMS.setSelected(Array.from(selCuisine));
    render();
  });

  /* ── District pill clicks ── */
  fgDistrict.addEventListener('click', function(e) {
    var btn = e.target.closest('.filter-pill[data-district]');
    if (!btn) return;
    var val = btn.getAttribute('data-district');
    if (selDistrict.has(val)) selDistrict.delete(val);
    else selDistrict.add(val);
    districtMS.setSelected(Array.from(selDistrict));
    syncDistrictPolygons();
    render();
  });

  /* ── Sync pill active states + overflow trigger text ── */
  function syncPills() {
    fgCuisine.querySelectorAll('.filter-pill[data-cuisine]').forEach(function(btn) {
      btn.classList.toggle('active', selCuisine.has(btn.getAttribute('data-cuisine')));
    });
    fgDistrict.querySelectorAll('.filter-pill[data-district]').forEach(function(btn) {
      btn.classList.toggle('active', selDistrict.has(btn.getAttribute('data-district')));
    });
  }

  /* ── District Choropleth (main map) ── */
  var districtGeoLayer = null;
  var districtLayers = Object.create(null);
  var districtLabels = Object.create(null);
  var districtGeoData = null;

  var DISTRICT_HIDE_ZOOM = 14; /* hide polygons at this zoom and above */

  function districtPolygonStyle(name, selected) {
    var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    var border = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();

    if (selected) {
      return { fillColor: accent, fillOpacity: 0.25, color: accent, weight: 2.5, opacity: 1 };
    }
    return { fillColor: accent, fillOpacity: 0.06, color: border, weight: 1, opacity: 0.6 };
  }

  function syncDistrictPolygons() {
    Object.keys(districtLayers).forEach(function(name) {
      var selected = selDistrict.has(name);
      districtLayers[name].setStyle(districtPolygonStyle(name, selected));
      /* Permanent label on selected districts */
      if (selected && !districtLabels[name] && map) {
        var center = districtLayers[name].getBounds().getCenter();
        districtLabels[name] = L.tooltip({ permanent: true, direction: 'center', className: 'district-label', interactive: false })
          .setContent(name)
          .setLatLng(center)
          .addTo(map);
      } else if (!selected && districtLabels[name]) {
        map.removeLayer(districtLabels[name]);
        delete districtLabels[name];
      }
    });
    /* Show/hide layer based on zoom + selection state */
    if (map && districtGeoLayer) {
      if (map.getZoom() >= DISTRICT_HIDE_ZOOM && selDistrict.size === 0) {
        if (map.hasLayer(districtGeoLayer)) map.removeLayer(districtGeoLayer);
      } else {
        if (!map.hasLayer(districtGeoLayer)) map.addLayer(districtGeoLayer);
      }
    }
  }

  function addDistrictLayer() {
    if (!map || !districtGeoData) return;
    if (districtGeoLayer) {
      map.removeLayer(districtGeoLayer); districtLayers = Object.create(null);
      Object.keys(districtLabels).forEach(function(k) { map.removeLayer(districtLabels[k]); });
      districtLabels = Object.create(null);
    }

    districtGeoLayer = L.geoJSON(districtGeoData, {
      style: function(feature) {
        return districtPolygonStyle(feature.properties.name, selDistrict.has(feature.properties.name));
      },
      onEachFeature: function(feature, layer) {
        var name = feature.properties.name;
        districtLayers[name] = layer;
        var count = districtCounts[name] || 0;

        layer.bindTooltip(name + ' (' + count + ')', {
          sticky: true, direction: 'top', className: 'map-tooltip'
        });

        layer.on('mouseover', function() {
          if (!selDistrict.has(name)) {
            layer.setStyle({ fillOpacity: layer.options.fillOpacity + 0.12, weight: 1.5 });
          }
        });
        layer.on('mouseout', function() {
          layer.setStyle(districtPolygonStyle(name, selDistrict.has(name)));
        });

        layer.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          /* Toggle district in checkbox list */
          var msOpts = document.querySelector('#ms-district .ms-opts');
          var inputs = msOpts.querySelectorAll('input[type="checkbox"]');
          for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].value === name) {
              inputs[i].checked = !inputs[i].checked;
              var row = inputs[i].closest('label');
              if (row) row.setAttribute('aria-selected', inputs[i].checked ? 'true' : 'false');
              break;
            }
          }
          selDistrict = new Set(districtMS.getSelected());
          var msEl = document.getElementById('ms-district');
          msEl.classList.toggle('has-sel', selDistrict.size > 0);
          /* Trigger text updated by setSelected via triggerFormat */
          districtMS.setSelected(Array.from(selDistrict));
          syncPills();
          syncDistrictPolygons();
          render();
        });
      }
    }).addTo(map);

    /* Hide/show polygons based on zoom level (keep selected visible) */
    function onZoomEnd() {
      if (!districtGeoLayer) return;
      if (map.getZoom() >= DISTRICT_HIDE_ZOOM && selDistrict.size === 0) {
        if (map.hasLayer(districtGeoLayer)) map.removeLayer(districtGeoLayer);
      } else {
        if (!map.hasLayer(districtGeoLayer)) map.addLayer(districtGeoLayer);
      }
    }
    map.on('zoomend', onZoomEnd);
  }

  function updateDistrictTooltips() {
    Object.keys(districtLayers).forEach(function(name) {
      var count = districtCounts[name] || 0;
      districtLayers[name].setTooltipContent(name + ' (' + count + ')');
    });
  }

  /* Fetch GeoJSON once, add to map when ready */
  function loadDistrictGeo() {
    if (districtGeoData) return Promise.resolve();
    return fetch('districts.geojson')
      .then(function(resp) { return resp.json(); })
      .then(function(data) { districtGeoData = data; });
  }

  /* ── Dynamic Counts ── */
  function splitCuisineTags(raw) {
    if (!raw) return [];
    return String(raw).split(/\u2022/).map(function(t) { return t.trim(); }).filter(Boolean);
  }

  function updateDynamicCounts() {
    var q = searchEl.value;
    var priceArr = Array.from(selPrice);

    /* Cuisine counts: apply all filters except cuisine */
    var forCuisine = app.getFiltered(RESTAURANTS, {
      query: q, priceValue: priceArr,
      selDistrict: selDistrict, selCuisine: new Set(),
      favsOnly: favsOnly, favs: favs,
      sort: 'rating', getFavKey: getFavKey, fuzzy: true
    });

    /* District counts: apply all filters except district */
    var forDistrict = app.getFiltered(RESTAURANTS, {
      query: q, priceValue: priceArr,
      selCuisine: selCuisine, selDistrict: new Set(),
      favsOnly: favsOnly, favs: favs,
      sort: 'rating', getFavKey: getFavKey, fuzzy: true
    });

    var cCounts = Object.create(null);
    forCuisine.forEach(function(r) {
      splitCuisineTags(r.c).forEach(function(t) {
        cCounts[t] = (cCounts[t] || 0) + 1;
      });
    });

    var dCounts = Object.create(null);
    forDistrict.forEach(function(r) {
      if (r.d) dCounts[r.d] = (dCounts[r.d] || 0) + 1;
    });

    cuisineMS.updateCounts(cCounts);
    districtMS.updateCounts(dCounts);
    /* Dim zero-count pills */
    fgCuisine.querySelectorAll('.filter-pill[data-cuisine]').forEach(function(btn) {
      var c = btn.getAttribute('data-cuisine');
      btn.classList.toggle('dimmed', (cCounts[c] || 0) === 0 && !selCuisine.has(c));
    });
    fgDistrict.querySelectorAll('.filter-pill[data-district]').forEach(function(btn) {
      var d = btn.getAttribute('data-district');
      btn.classList.toggle('dimmed', (dCounts[d] || 0) === 0 && !selDistrict.has(d));
    });
    syncDistrictPolygons();
    updateDistrictTooltips();
  }

  /* ── Price Tier Buttons (multi-select) ── */
  var priceBtns = [].slice.call(document.querySelectorAll('.filter-pill[data-price]'));
  priceBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      var val = btn.getAttribute('data-price');
      if (selPrice.has(val)) {
        selPrice.delete(val);
      } else {
        selPrice.add(val);
      }
      updatePriceUI();
      render();
    });
  });
  function updatePriceUI() {
    priceBtns.forEach(function(btn) {
      btn.classList.toggle('active', selPrice.has(btn.getAttribute('data-price')));
    });
  }

  /* ── Sort Dropdown ── */
  var sortLabels = { rating: 'Ranking', name: 'A-Z', price: 'Precio', distance: 'Distancia' };

  function updateSortUI() {
    sortLabel.textContent = sortLabels[sort] || 'Ranking';
    sortDrop.querySelectorAll('.sort-option').forEach(function(b) {
      var isActive = b.getAttribute('data-sort') === sort;
      b.classList.toggle('active', isActive);
      b.setAttribute('aria-selected', isActive ? 'true' : 'false');
    });
  }

  function closeSortDrop() {
    sortWrap.classList.remove('open');
    sortTrigger.setAttribute('aria-expanded', 'false');
  }

  sortTrigger.addEventListener('click', function(e) {
    e.stopPropagation();
    /* Close other dropdowns */
    cuisineMS.close();
    districtMS.close();

    var isOpen = sortWrap.classList.contains('open');
    if (isOpen) {
      closeSortDrop();
    } else {
      sortWrap.classList.add('open');
      sortTrigger.setAttribute('aria-expanded', 'true');
    }
  });

  sortDrop.addEventListener('click', function(e) {
    e.stopPropagation();
    var btn = e.target.closest('.sort-option');
    if (!btn) return;
    var newSort = btn.getAttribute('data-sort');
    /* If choosing distance and no geo yet, trigger geolocation */
    if (newSort === 'distance' && userLat === null) {
      activateGeo(function() {
        sort = 'distance';
        updateSortUI();
        closeSortDrop();
        render();
      });
      closeSortDrop();
      return;
    }
    sort = newSort;
    updateSortUI();
    closeSortDrop();
    render();
  });

  sortWrap.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeSortDrop(); sortTrigger.focus(); }
  });

  /* Close dropdowns on outside click */
  document.addEventListener('click', function() {
    cuisineMS.close();
    districtMS.close();

    closeSortDrop();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    cuisineMS.close();
    districtMS.close();

    closeSortDrop();
  });

  /* ── URL State ── */
  function syncURL() {
    var p = new URLSearchParams();
    if (searchEl.value.trim()) p.set('q', searchEl.value.trim());
    if (selCuisine.size) Array.from(selCuisine).forEach(function(c) { p.append('c', c); });
    if (selDistrict.size) Array.from(selDistrict).forEach(function(d) { p.append('d', d); });
    if (selPrice.size) Array.from(selPrice).forEach(function(v) { p.append('p', v); });
    if (sort !== 'rating') p.set('s', sort);
    if (favsOnly) p.set('f', '1');
    var qs = p.toString();
    history.replaceState(null, '', qs ? '?' + qs : location.pathname);
  }
  function readURL() {
    var p = new URLSearchParams(location.search);
    if (p.has('q')) searchEl.value = p.get('q');
    var v = p.getAll('c');
    if (v.length === 1 && v[0].indexOf(',') !== -1) v = v[0].split(',');
    if (v.length) { selCuisine = new Set(v); cuisineMS.setSelected(v); }
    var v2 = p.getAll('d');
    if (v2.length === 1 && v2[0].indexOf(',') !== -1) v2 = v2[0].split(',');
    if (v2.length) { selDistrict = new Set(v2); districtMS.setSelected(v2); }
    var pv = p.getAll('p');
    if (pv.length) { selPrice = new Set(pv); updatePriceUI(); }
    if (p.has('s')) {
      sort = p.get('s');
      updateSortUI();
    }
    if (p.get('f') === '1') favsOnly = true;
    syncPills();
  }

  /* ── Filter & Sort ── */
  function getFilteredLocal() {
    return app.getFiltered(RESTAURANTS, {
      query: searchEl.value,
      priceValue: Array.from(selPrice),
      selCuisine: selCuisine,
      selDistrict: selDistrict,
      favsOnly: favsOnly,
      favs: favs,
      sort: sort,
      getFavKey: getFavKey,
      fuzzy: true,
    });
  }

  /* ── Card Builder ── */
  function buildCard(r, batchIdx, absoluteIdx) {
    var favKey = getFavKey(r);
    var isFav  = favs.has(favKey);
    var heart  = isFav ? '\u2665' : '\u2661';
    var favCls = isFav ? ' active' : '';
    var rCls   = r.r && r.r !== '-' ? '' : ' no-r';
    var ratingValue = parseFloat(r.r);
    var topRatedCls = (!isNaN(ratingValue) && ratingValue >= 9) ? ' top-rated' : '';
    var revealCls = absoluteIdx >= BATCH ? ' reveal' : '';
    var rText  = r.r && r.r !== '-' ? r.r : '\u2014';
    var tags   = r.c ? r.c.split(/\u2022/).map(function(t) {
      return t.trim();
    }).filter(Boolean).join(', ') : '';
    var price  = r.p ? r.p + ' \u20ac' : '';
    var gmaps  = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent((r.n || '') + ', ' + (r.a || ''));
    var websiteUrl = safeHttpUrl(r.w);
    var sourceUrl = safeHttpUrl(r.u || (r.s ? ('https://macarfi.com/es/mad/ficha-restaurante/' + encodeURIComponent(r.s)) : ''));
    var pageUrl = r.s ? '/r/' + encodeURIComponent(r.s) + '.html' : sourceUrl;
    if (!pageUrl) pageUrl = '#';
    var eName  = esc(r.n);
    var eFavKey = esc(favKey);

    /* Expandable detail */
    var rDetail = [
      r.rf ? 'Comida <strong>' + esc(r.rf) + '</strong>' : '',
      r.rd ? 'Decor <strong>' + esc(r.rd) + '</strong>' : '',
      r.rs ? 'Servicio <strong>' + esc(r.rs) + '</strong>' : ''
    ].filter(Boolean).join(' \u00b7 ');
    var phoneValue = r.ph ? String(r.ph).replace(/\s/g,'') : '';
    var phone = phoneValue ? '<div class="card-phone"><a href="tel:' + esc(phoneValue) + '">' + esc(r.ph) + '</a></div>' : '';
    var addr  = r.a ? '<div class="card-address">' + esc(r.a) + '</div>' : '';
    var hasDetail = rDetail || r.ph || r.a;

    return '<div class="card' + topRatedCls + revealCls + '" tabindex="0" role="article" aria-label="' + eName + '">' +
      '<div class="card-top">' +
        '<div class="card-name"><a href="' + pageUrl + '">' + eName + '</a></div>' +
        '<button class="fav-btn' + favCls + '" data-fav-key="' + eFavKey + '" aria-label="Favorito: ' + eName + '" aria-pressed="' + (isFav ? 'true' : 'false') + '">' + heart + '</button>' +
        '<div class="card-rating' + rCls + '">' + esc(rText) + '</div>' +
      '</div>' +
      '<div class="card-meta">' +
        (r.d ? '<span>' + esc(r.d) + '</span>' : '') +
        (price ? '<span>' + esc(price) + '</span>' : '') +
        (r._dist != null ? '<span class="card-dist">' + formatDist(r._dist) + '</span>' : '') +
      '</div>' +
      (tags ? '<div class="card-tags">' + esc(tags) + '</div>' : '') +
      (hasDetail ? '<div class="card-expand"><div>' +
        '<div class="card-detail">' +
          (rDetail ? '<div class="card-ratings">' + rDetail + '</div>' : '') +
          addr + phone +
        '</div>' +
      '</div></div>' : '') +
      '<div class="card-actions">' +
        '<a href="' + gmaps + '" target="_blank" rel="noopener noreferrer">Ver en Maps</a>' +
        (websiteUrl ? '<a href="' + websiteUrl + '" target="_blank" rel="noopener noreferrer">Web</a>' : '') +
        (sourceUrl ? '<a href="' + sourceUrl + '" target="_blank" rel="noopener noreferrer">Macarfi</a>' : '') +
      '</div>' +
    '</div>';
  }

  /* ── Progressive Rendering (load-more button) ── */
  var loadMoreWrap = document.createElement('div');
  loadMoreWrap.className = 'load-more';
  var loadMoreBtn = document.createElement('button');
  loadMoreBtn.className = 'load-more-btn';
  loadMoreBtn.type = 'button';
  loadMoreWrap.appendChild(loadMoreBtn);
  loadMoreBtn.addEventListener('click', function() {
    if (loadMoreWrap.parentNode) loadMoreWrap.remove();
    var firstNew = grid.querySelectorAll('.card').length;
    renderBatch();
    var newCard = grid.querySelectorAll('.card')[firstNew];
    if (newCard) newCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  });

  function showLoadMore() {
    var remaining = filtered.length - rendered;
    if (remaining <= 0) return;
    loadMoreBtn.textContent = 'Mostrar más (' + remaining + ' restantes)';
    if (loadMoreWrap.parentNode) loadMoreWrap.remove();
    grid.appendChild(loadMoreWrap);
  }

  function renderBatch() {
    var startIdx = rendered;
    var batch = filtered.slice(rendered, rendered + BATCH);
    if (!batch.length) return;
    if (loadMoreWrap.parentNode) loadMoreWrap.remove();
    var htmlParts = [];
    batch.forEach(function(r, i) {
      var absoluteIdx = startIdx + i;
      if (sort === 'name') {
        var districtLabel = r.d || 'Sin zona';
        if (districtLabel !== lastRenderedDistrict) {
          htmlParts.push('<div class="district-header">' + esc(districtLabel) + '</div>');
          lastRenderedDistrict = districtLabel;
        }
      }
      htmlParts.push(buildCard(r, i, absoluteIdx));
    });
    grid.insertAdjacentHTML('beforeend', htmlParts.join(''));
    rendered += batch.length;
    ensureRevealObserver();
    observeReveals();
    if (rendered < filtered.length) {
      showLoadMore();
    }
  }

  function render() {
    if (loadMoreWrap.parentNode) loadMoreWrap.remove();
    filtered = getFilteredLocal();
    grid.innerHTML = '';
    rendered = 0;
    lastRenderedDistrict = '';
    if (!filtered.length) {
      if (favsOnly && !favs.size) {
        grid.innerHTML = '<div class="no-results"><p>Marca restaurantes con el coraz\u00f3n para verlos aqu\u00ed.</p></div>';
      } else {
        grid.innerHTML = '<div class="no-results"><p>No se encontraron restaurantes con esos filtros.</p><button class="clear-filters" type="button">Limpiar filtros</button></div>';
      }
    } else {
      renderBatch();
    }
    syncURL();
    updateActiveFilters();
    syncPills();
    updateDynamicCounts();
    updateFilterToggle();
    if (view === 'map' && leafletOk && clusterOk) updateMap();
  }

  /* ── Map ── */
  function loadLeaflet() {
    return new Promise(function(resolve) {
      if (leafletOk && clusterOk) { resolve(); return; }
      /* Leaflet core */
      var css = document.createElement('link');
      css.rel = 'stylesheet';
      css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      css.integrity = LEAFLET_CSS_INTEGRITY;
      css.crossOrigin = 'anonymous';
      document.head.appendChild(css);
      var js = document.createElement('script');
      js.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      js.integrity = LEAFLET_JS_INTEGRITY;
      js.crossOrigin = 'anonymous';
      js.onload = function() {
        leafletOk = true;
        /* Chain-load MarkerCluster */
        var mcCssBase = document.createElement('link');
        mcCssBase.rel = 'stylesheet';
        mcCssBase.href = MC_BASE + '/MarkerCluster.css';
        mcCssBase.integrity = MC_CSS_BASE_INTEGRITY;
        mcCssBase.crossOrigin = 'anonymous';
        document.head.appendChild(mcCssBase);
        var mcCss = document.createElement('link');
        mcCss.rel = 'stylesheet';
        mcCss.href = MC_BASE + '/MarkerCluster.Default.css';
        mcCss.integrity = MC_CSS_INTEGRITY;
        mcCss.crossOrigin = 'anonymous';
        document.head.appendChild(mcCss);
        var mcJs = document.createElement('script');
        mcJs.src = MC_BASE + '/leaflet.markercluster.js';
        mcJs.integrity = MC_JS_INTEGRITY;
        mcJs.crossOrigin = 'anonymous';
        mcJs.onload = function() { clusterOk = true; resolve(); };
        document.head.appendChild(mcJs);
      };
      document.head.appendChild(js);
    });
  }

  /* Marker SVG icon — uniform pin-drop shape */
  function markerIcon() {
    var w = 14, h = 19, opacity = 1;
    /* Teardrop pin: top circle + bottom point */
    var cx = w / 2;
    var cr = w / 2 - 1;
    var svg = '<svg width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h +
      '" xmlns="http://www.w3.org/2000/svg">' +
      '<path d="M' + cx + ' ' + h +
      ' C' + (cx - cr * 0.7) + ' ' + (h * 0.62) +
      ' 1 ' + (cr + 2) +
      ' 1 ' + (cr + 1) +
      ' A' + cr + ' ' + cr + ' 0 1 1 ' + (w - 1) + ' ' + (cr + 1) +
      ' C' + (w - 1) + ' ' + (cr + 2) +
      ' ' + (cx + cr * 0.7) + ' ' + (h * 0.62) +
      ' ' + cx + ' ' + h + 'Z"' +
      ' fill="currentColor" opacity="' + opacity + '" stroke="#fff" stroke-width="1.2"/>' +
      '<circle cx="' + cx + '" cy="' + (cr + 1) + '" r="' + (cr * 0.38) +
      '" fill="#fff" opacity="0.9"/></svg>';
    return L.divIcon({
      html: '<div class="map-marker" style="color:var(--accent)">' + svg + '</div>',
      className: '',
      iconSize: [w, h],
      iconAnchor: [w / 2, h],
      popupAnchor: [0, -h + 4]
    });
  }

  /* Build rich popup HTML */
  function buildPopup(r) {
    var tags = (r.c || '').split(/\u2022/).map(function(t) { return t.trim(); }).filter(Boolean);
    var html = '<div class="map-popup">';
    html += '<div class="map-popup-name">' + esc(r.n) + '</div>';
    if (r.r && r.r !== '-') html += '<span class="map-popup-rating">' + esc(r.r) + '</span> ';
    html += '<div class="map-popup-meta">';
    var parts = [];
    if (r.d) parts.push(esc(r.d));
    if (r.p) parts.push(esc(r.p) + ' \u20AC');
    html += parts.join(' \u00B7 ');
    html += '</div>';
    if (tags.length) {
      html += '<div class="map-popup-tags">' + esc(tags.slice(0, 3).join(', ')) + '</div>';
    }
    if (r.s) html += '<a class="map-popup-link" href="/r/' + encodeURIComponent(r.s) + '.html">Ver m\u00e1s \u2192</a>';
    html += '</div>';
    return html;
  }

  /* Build tooltip content */
  function buildTooltip(r) {
    var html = esc(r.n);
    if (r.r && r.r !== '-') html += ' <span class="map-tt-rating">' + esc(r.r) + '</span>';
    return html;
  }

  /* Sync panel to visible map bounds */
  function updateMapPanel() {
    if (!map) return;
    var bounds = map.getBounds();
    var visibleCount = 0;
    markerIndex.forEach(function(item) {
      var visible = bounds.contains(item.marker.getLatLng());
      if (item.panelEl) item.panelEl.style.display = visible ? '' : 'none';
      if (visible) visibleCount += 1;
    });
    if (mapVisibleCountEl) mapVisibleCountEl.textContent = visibleCount + ' visibles';
    var countBadge = document.getElementById('map-count-badge');
    if (countBadge) countBadge.textContent = visibleCount + ' restaurantes visibles';
  }

  /* Highlight panel item + scroll into view */
  function highlightPanel(slug) {
    if (activePanelSlug === slug) return;
    activePanelSlug = slug;
    markerIndex.forEach(function(item) {
      if (item.panelEl) {
        item.panelEl.classList.toggle('active', item.data.s === slug);
        if (item.data.s === slug) {
          item.panelEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      }
    });
  }

  function initMap() {
    mapCont.hidden = false;
    grid.style.display = 'none';
    document.body.classList.add('map-mode');
    var ch = document.querySelector('.controls-wrap').offsetHeight;
    document.body.style.setProperty('--controls-h', ch + 'px');
    updateFilterToggle();
    if (map) { updateMap(); setTimeout(function() { map.invalidateSize(); }, 50); return; }
    loadLeaflet().then(function() {
      map = L.map('map-view').setView([40.42, -3.7], 13);
      map.attributionControl.setPrefix('');
      tileLayer = L.tileLayer(getTileUrl(), { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>' }).addTo(map);
      document.getElementById('map-view').classList.add('loaded');
      map.on('moveend', updateMapPanel);
      /* Load district polygons as background choropleth */
      loadDistrictGeo().then(function() { addDistrictLayer(); });
      updateMap();
      setTimeout(function() { map.invalidateSize(); }, 50);
    });
  }

  function updateMap() {
    if (!map) return;
    if (mapVisibleCountEl) mapVisibleCountEl.textContent = '';
    /* Clear previous */
    if (clusterGroup) { map.removeLayer(clusterGroup); }
    markerIndex = [];
    activePanelSlug = null;
    mapPanel.innerHTML = '';

    clusterGroup = L.markerClusterGroup({
      maxClusterRadius: function(zoom) {
        /* Aggressive disaggregation: tight radius at higher zooms */
        if (zoom >= 16) return 10;
        if (zoom >= 14) return 20;
        if (zoom >= 12) return 30;
        return 40;
      },
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      disableClusteringAtZoom: 17,
      animateAddingMarkers: true
    });

    var isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

    filtered.forEach(function(r) {
      if (!r.lat || !r.lng) return;
      var latlng = L.latLng(parseFloat(r.lat), parseFloat(r.lng));
      var m = L.marker(latlng, { icon: markerIcon(r.r) });
      m.bindPopup(buildPopup(r), { maxWidth: 260, minWidth: 180 });
      /* Tooltip only on non-touch devices */
      if (!isTouchDevice) {
        m.bindTooltip(buildTooltip(r), { className: 'map-tooltip', direction: 'top', offset: [0, -6] });
      }

      /* Panel item */
      var li = document.createElement('li');
      li.className = 'map-panel-item';
      var meta = [];
      if (r.d) meta.push(esc(r.d));
      if (r.p) meta.push(esc(r.p) + ' \u20AC');
      li.innerHTML = '<span class="map-panel-name">' + esc(r.n) + '</span>' +
        '<span class="map-panel-meta">' +
        (r.r && r.r !== '-' ? '<span class="map-panel-rating">' + esc(r.r) + '</span> ' : '') +
        meta.join(' \u00B7 ') +
        '</span>';
      /* Click panel → fly to marker + open popup */
      li.addEventListener('click', function() {
        map.flyTo(latlng, 16, { duration: 0.6 });
        clusterGroup.zoomToShowLayer(m, function() {
          m.openPopup();
        });
        highlightPanel(r.s);
      });
      mapPanel.appendChild(li);

      /* Click marker → highlight panel */
      m.on('popupopen', function() { highlightPanel(r.s); });

      markerIndex.push({ marker: m, data: r, panelEl: li });
      clusterGroup.addLayer(m);
    });

    map.addLayer(clusterGroup);
    /* District polygons are in overlayPane (z-400), above tiles (z-200) but below markers (z-600) */

    /* User position marker */
    if (userMarker) { userMarker.remove(); userMarker = null; }
    if (userLat !== null) {
      var accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
      userMarker = L.circleMarker([userLat, userLng], {
        radius: 8, fillColor: accentColor, fillOpacity: 1, color: '#fff', weight: 2.5
      }).bindPopup('Tu ubicaci\u00f3n').addTo(map);
    }

    /* Fit bounds only on first load */
    if (!mapFitDone) {
      var allMarkers = markerIndex.map(function(item) { return item.marker; });
      if (userMarker) allMarkers.push(userMarker);
      if (allMarkers.length) {
        var group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
      mapFitDone = true;
    }
    updateMapPanel();
  }

  function showGrid() {
    mapCont.hidden = true;
    grid.style.display = '';
    view = 'grid';
    document.body.classList.remove('map-mode');
    document.querySelector('.controls-row-2').classList.remove('filters-open');
  }

  /* ── Back to Top + Sticky Shadow ── */
  var controlsWrap = document.querySelector('.controls-wrap');
  var scrollTick = false;
  window.addEventListener('scroll', function() {
    if (!scrollTick) {
      requestAnimationFrame(function() {
        bttEl.classList.toggle('visible', window.scrollY > 500);
        controlsWrap.classList.toggle('scrolled', window.scrollY > 80);
        scrollTick = false;
      });
      scrollTick = true;
    }
  });
  bttEl.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });

  /* ── Filtros toggle (map mode) ── */
  var filterToggle = document.getElementById('filter-toggle');
  var controlsRow2 = document.querySelector('.controls-row-2');

  function updateFilterToggle() {
    var count = selCuisine.size + selDistrict.size + selPrice.size;
    filterToggle.textContent = count > 0
      ? 'Filtros (' + count + ') \u25BE'
      : 'Filtros \u25BE';
    filterToggle.classList.toggle('has-filters', count > 0);
  }

  filterToggle.addEventListener('click', function(e) {
    e.stopPropagation();
    controlsRow2.classList.toggle('filters-open');
  });

  document.addEventListener('click', function(e) {
    if (!document.body.classList.contains('map-mode')) return;
    if (!controlsRow2.classList.contains('filters-open')) return;
    if (controlsRow2.contains(e.target) || filterToggle.contains(e.target)) return;
    controlsRow2.classList.remove('filters-open');
  });

  /* ── Card interactions (delegated) ── */
  grid.addEventListener('click', function(e) {
    /* Clear filters button */
    if (e.target.closest('.clear-filters')) {
      searchEl.value = '';
      selPrice = new Set(); updatePriceUI();
      selCuisine = new Set(); cuisineMS.setSelected([]);
      selDistrict = new Set(); districtMS.setSelected([]); syncDistrictPolygons();
      syncPills();
      if (favsOnly) { favsOnly = false; updateFavBtn(); }
      render();
      return;
    }
    /* Favorite toggle */
    var fb = e.target.closest('.fav-btn');
    if (fb) { e.stopPropagation(); toggleFav(fb.getAttribute('data-fav-key')); return; }
    /* Links pass through */
    if (e.target.closest('a')) return;
    /* Expand/collapse */
    var card = e.target.closest('.card');
    if (card) card.classList.toggle('expanded');
  });
  grid.addEventListener('keydown', function(e) {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    var card = e.target.closest('.card');
    if (!card) return;
    if (e.target.closest('a') || e.target.closest('.fav-btn')) return;
    e.preventDefault();
    card.classList.toggle('expanded');
  });

  function ensureCardVisible(index) {
    while (rendered <= index && rendered < filtered.length) {
      renderBatch();
    }
  }

  function setViewButton(viewName) {
    document.querySelectorAll('.view-link[data-view]').forEach(function(b) {
      b.classList.toggle('active', b.getAttribute('data-view') === viewName);
    });
  }

  function runSurprise() {
    if (!filtered.length) return;
    if (view !== 'grid') {
      showGrid();
      setViewButton('grid');
    }
    var idx = Math.floor(Math.random() * filtered.length);
    ensureCardVisible(idx);
    var cards = grid.querySelectorAll('.card');
    var card = cards[idx];
    if (!card) return;
    card.classList.add('expanded');
    card.scrollIntoView({
      behavior: prefersReducedMotion ? 'auto' : 'smooth',
      block: 'center',
    });
    card.focus({ preventScroll: true });
  }

  /* ── Event Listeners ── */
  var searchTimer;
  var searchClear = document.getElementById('search-clear');
  function updateSearchClear() {
    searchClear.hidden = !searchEl.value;
  }
  searchEl.addEventListener('input', function() {
    clearTimeout(searchTimer);
    updateSearchClear();
    searchTimer = setTimeout(render, 150);
  });
  searchClear.addEventListener('click', function() {
    searchEl.value = '';
    updateSearchClear();
    searchEl.focus();
    render();
  });

  activeFiltersEl.addEventListener('click', function(e) {
    var btn = e.target.closest('.tag-dismiss');
    if (!btn) return;
    var tag = btn.parentElement;
    var type = tag.getAttribute('data-filter-type');
    var value = tag.getAttribute('data-filter-value');
    if (type === 'search') { searchEl.value = ''; updateSearchClear(); }
    else if (type === 'cuisine') { selCuisine.delete(value); cuisineMS.setSelected(Array.from(selCuisine)); }
    else if (type === 'district') { selDistrict.delete(value); districtMS.setSelected(Array.from(selDistrict)); syncDistrictPolygons(); }
    else if (type === 'price') { selPrice.delete(value); updatePriceUI(); }
    render();
  });

  document.querySelectorAll('.view-link[data-view]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.view-link[data-view]').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var v = btn.getAttribute('data-view');
      if (v === 'map') { view = 'map'; initMap(); }
      else showGrid();
    });
  });

  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

  favBtn.addEventListener('click', function() {
    favsOnly = !favsOnly;
    updateFavBtn();
    render();
  });
  surpriseBtn.addEventListener('click', runSurprise);

  /* ── Dynamic footer ── */
  function updateFooter() {
    if (typeof META === 'undefined') return;
    var d = new Date(META.updated);
    if (isNaN(d)) return;
    var months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
    var el = document.getElementById('footer-updated');
    if (el) el.textContent = 'Actualizado ' + months[d.getMonth()] + ' ' + d.getFullYear();
  }

  /* ── Init ── */
  initTheme();
  readURL();
  updateFavBtn();
  updateFooter();
  render();
})();

/* ── Service Worker ── */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
