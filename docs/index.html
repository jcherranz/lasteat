<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<title>Last Eat — Restaurantes en Madrid</title>
<meta name="description" content="Descubre los mejores restaurantes de Madrid. 770+ restaurantes con valoraciones, precios y ubicaciones. Filtra por cocina, zona y precio.">
<link rel="canonical" href="https://lasteat.es/">
<link rel="preload" href="data.js" as="script">

<!-- Open Graph -->
<meta property="og:type" content="website">
<meta property="og:title" content="Last Eat — Restaurantes en Madrid">
<meta property="og:description" content="Descubre los mejores restaurantes de Madrid. 770+ restaurantes con valoraciones, precios y ubicaciones.">
<meta property="og:url" content="https://lasteat.es/">
<meta property="og:site_name" content="Last Eat">
<meta property="og:image" content="https://lasteat.es/og.png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">

<!-- Twitter Card -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Last Eat — Restaurantes en Madrid">
<meta name="twitter:description" content="Descubre los mejores restaurantes de Madrid. 770+ restaurantes con valoraciones, precios y ubicaciones.">
<meta name="twitter:image" content="https://lasteat.es/og.png">

<!-- PWA -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#376660">
<link rel="apple-touch-icon" href="/icons/icon-192.png">

<style>
  /* ── Theme Variables ── */
  :root {
    --bg: #F5F4F1;
    --surface: #FFFFFF;
    --text: #1C1F1E;
    --secondary: #545957;
    --muted: #6E7472;
    --accent: #376660;
    --accent-soft: rgba(55, 102, 96, 0.06);
    --border: #E2E0DC;
    --radius: 5px;
    --tile: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";
  }
  [data-theme="dark"] {
    --bg: #131615;
    --surface: #1C201E;
    --text: #E4E6E4;
    --secondary: #9DA2A0;
    --muted: #95A09D;
    --accent: #45A194;
    --accent-soft: rgba(69, 161, 148, 0.09);
    --border: #292D2B;
  }

  /* ── Base ── */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }
  .skip-link {
    position: absolute;
    left: 1rem;
    top: -40px;
    padding: 0.45rem 0.7rem;
    background: var(--surface);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.78rem;
    text-decoration: none;
    z-index: 400;
  }
  .skip-link:focus {
    top: 1rem;
  }
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
    white-space: nowrap;
  }
  a:focus-visible,
  button:focus-visible,
  input:focus-visible,
  select:focus-visible,
  .card:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* ── Masthead ── */
  header {
    padding: 3rem 2rem 0;
    text-align: center;
    position: relative;
  }
  .logo {
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 2.8rem;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    line-height: 1.1;
  }
  .stats {
    font-size: 0.78rem;
    color: var(--muted);
    margin-top: 0.6rem;
    letter-spacing: 0.06em;
  }
  .divider {
    width: 36px;
    height: 1px;
    background: var(--border);
    margin: 1.5rem auto 0;
  }
  .theme-toggle {
    position: absolute;
    top: 1.25rem;
    right: 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    color: var(--muted);
    padding: 0.25rem;
    transition: color 0.2s;
    line-height: 1;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .theme-toggle::before { content: '\263D'; }
  [data-theme="dark"] .theme-toggle::before { content: '\2600'; }
  .theme-toggle:hover { color: var(--accent); }

  /* ── Controls ── */
  .controls-wrap {
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
  }
  .controls-wrap::after {
    content: '';
    position: absolute;
    bottom: -16px;
    left: 0;
    right: 0;
    height: 16px;
    background: linear-gradient(var(--bg), transparent);
    pointer-events: none;
  }
  .controls {
    max-width: 1100px;
    margin: 0 auto;
    padding: 1rem 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.45rem;
    align-items: center;
  }
  .search-box {
    flex: 1;
    min-width: 160px;
    padding: 0.5rem 0;
    min-height: 44px;
    border: none;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
    font-family: inherit;
    background: transparent;
    outline: none;
    transition: border-color 0.3s;
    color: var(--text);
  }
  .search-box::placeholder { color: var(--muted); }
  .search-box:focus { border-bottom-color: var(--accent); }

  select {
    padding: 0.45rem 1.7rem 0.45rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.78rem;
    font-family: inherit;
    background: var(--surface);
    color: var(--secondary);
    outline: none;
    cursor: pointer;
    transition: border-color 0.3s;
    -webkit-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236E7472'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.55rem center;
    min-height: 44px;
  }
  select:focus { border-color: var(--accent); }

  /* ── Multi-select ── */
  .ms { position: relative; }
  .ms-trigger {
    padding: 0.45rem 1.7rem 0.45rem 0.6rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.78rem;
    font-family: inherit;
    background: var(--surface);
    color: var(--secondary);
    cursor: pointer;
    white-space: nowrap;
    transition: border-color 0.3s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236E7472'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.55rem center;
    min-height: 44px;
  }
  .ms-trigger:hover, .ms.open .ms-trigger { border-color: var(--accent); }
  .ms.has-sel .ms-trigger { border-color: var(--accent); color: var(--accent); }
  .ms-drop {
    display: none;
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    min-width: 220px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    z-index: 200;
    overflow: hidden;
  }
  .ms.open .ms-drop {
    display: block;
    animation: dropIn 0.15s ease;
  }
  @keyframes dropIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .ms-search {
    width: 100%;
    padding: 0.5rem 0.6rem;
    min-height: 44px;
    border: none;
    border-bottom: 1px solid var(--border);
    font-size: 0.78rem;
    font-family: inherit;
    outline: none;
    background: transparent;
    color: var(--text);
  }
  .ms-search::placeholder { color: var(--muted); }
  .ms-opts {
    max-height: 200px;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
  }
  .ms-opts::-webkit-scrollbar { width: 4px; }
  .ms-opts::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .ms-opts label {
    display: flex;
    align-items: center;
    padding: 0.3rem 0.6rem;
    font-size: 0.78rem;
    color: var(--secondary);
    cursor: pointer;
    transition: background 0.1s;
    gap: 0.4rem;
  }
  .ms-opts label:hover { background: var(--accent-soft); }
  .ms-opts label.active { background: var(--accent-soft); }
  .ms-opts input[type="checkbox"] {
    -webkit-appearance: none;
    appearance: none;
    width: 13px;
    height: 13px;
    border: 1.5px solid var(--border);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    flex-shrink: 0;
  }
  .ms-opts input:checked {
    background: var(--accent);
    border-color: var(--accent);
  }
  .ms-opts input:checked::after {
    content: '';
    position: absolute;
    left: 3px;
    top: 0px;
    width: 4px;
    height: 7px;
    border: solid #fff;
    border-width: 0 1.5px 1.5px 0;
    transform: rotate(45deg);
  }
  .ms-clear {
    display: none;
    width: 100%;
    min-height: 44px;
    padding: 0.35rem;
    border: none;
    border-top: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    font-size: 0.72rem;
    font-family: inherit;
    cursor: pointer;
    transition: color 0.2s;
  }
  .ms.has-sel .ms-clear { display: block; }
  .ms-clear:hover { color: var(--accent); }

  /* ── Control buttons ── */
  .ctrl-btn {
    padding: 0.4rem 0.55rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.85rem;
    font-family: inherit;
    background: var(--surface);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    line-height: 1;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .ctrl-btn:hover { border-color: var(--accent); color: var(--accent); }
  .ctrl-btn.active { border-color: var(--accent); color: var(--accent); }
  .ctrl-btn.loading { opacity: 0.5; pointer-events: none; }

  .card-dist {
    font-size: 0.7rem;
    color: var(--accent);
    font-weight: 500;
    white-space: nowrap;
  }

  .sep {
    width: 1px;
    height: 18px;
    background: var(--border);
    margin: 0 0.15rem;
  }

  .btn-group {
    display: flex;
    align-items: center;
    gap: 0.1rem;
  }
  .sort-btn, .view-btn {
    padding: 0.38rem 0.7rem;
    border: none;
    border-radius: var(--radius);
    font-size: 0.76rem;
    font-family: inherit;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    white-space: nowrap;
    transition: color 0.2s, background 0.2s;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .sort-btn:hover, .view-btn:hover { color: var(--secondary); }
  .sort-btn.active, .view-btn.active {
    color: var(--text);
    background: var(--surface);
    font-weight: 500;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }

  /* ── Grid ── */
  .grid {
    max-width: 1100px;
    margin: 0.75rem auto 0;
    padding: 0 2rem 3rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 0.6rem;
  }
  .sentinel { height: 1px; grid-column: 1 / -1; }

  /* ── Card ── */
  .card {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 1.1rem 1.3rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.03);
    transition: box-shadow 0.25s;
    cursor: pointer;
  }
  .card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
  .card.expanded { box-shadow: 0 3px 16px rgba(0,0,0,0.08); }

  .card-top {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
  }
  .card-name {
    flex: 1;
    font-size: 0.88rem;
    font-weight: 500;
    line-height: 1.35;
    min-width: 0;
  }
  .card-name a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s;
  }
  .card-name a:hover { color: var(--accent); }
  .fav-btn {
    background: none;
    border: none;
    padding: 0.4rem;
    cursor: pointer;
    font-size: 0.85rem;
    color: var(--muted);
    transition: color 0.15s, transform 0.15s;
    line-height: 1;
    flex-shrink: 0;
    min-width: 44px;
    min-height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .fav-btn:hover { color: var(--accent); transform: scale(1.15); }
  .fav-btn.active { color: var(--accent); }
  .card-rating {
    flex-shrink: 0;
    font-family: 'Cormorant Garamond', Georgia, serif;
    font-size: 1.3rem;
    font-weight: 500;
    color: var(--text);
    line-height: 1;
  }
  .card-rating.no-r { color: var(--muted); font-size: 1rem; }

  .card-meta {
    font-size: 0.76rem;
    color: var(--muted);
    display: flex;
    flex-wrap: wrap;
  }
  .card-meta span + span::before {
    content: '\00b7';
    margin: 0 0.35rem;
    color: var(--border);
  }

  .card-tags { display: flex; flex-wrap: wrap; gap: 0.25rem; }
  .tag {
    font-size: 0.66rem;
    padding: 0.12rem 0.4rem;
    background: var(--accent-soft);
    color: var(--accent);
    border-radius: 3px;
    white-space: nowrap;
  }

  .card-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: auto;
    padding-top: 0.2rem;
  }
  .card-actions a {
    font-size: 0.7rem;
    color: var(--muted);
    text-decoration: none;
    transition: color 0.2s;
    display: inline-flex;
    align-items: center;
    min-height: 44px;
  }
  .card-actions a:hover { color: var(--accent); }

  /* ── Card Expand ── */
  .card-expand {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.25s ease;
  }
  .card.expanded .card-expand { grid-template-rows: 1fr; }
  .card-expand > div { overflow: hidden; }
  .card-detail {
    padding-top: 0.45rem;
    margin-top: 0.15rem;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }
  .card-ratings {
    font-size: 0.72rem;
    color: var(--muted);
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .card-ratings strong { color: var(--secondary); font-weight: 500; }
  .card-address {
    font-size: 0.72rem;
    color: var(--muted);
    line-height: 1.4;
  }
  .card-phone a {
    font-size: 0.72rem;
    color: var(--accent);
    text-decoration: none;
  }
  .card-phone a:hover { text-decoration: underline; }

  .no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 1.5rem;
    color: var(--muted);
    font-size: 0.88rem;
    background: var(--surface);
    border-radius: var(--radius);
  }

  /* ── Map ── */
  #map-container {
    max-width: 1100px;
    margin: 0.75rem auto 0;
    padding: 0 2rem 3rem;
  }
  #map-view {
    height: 70vh;
    border-radius: var(--radius);
    background: var(--surface);
  }

  /* ── Back to top ── */
  .btt {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    font-size: 0.9rem;
    cursor: pointer;
    opacity: 0;
    transform: translateY(8px);
    transition: opacity 0.3s, transform 0.3s, color 0.2s, border-color 0.2s;
    pointer-events: none;
    z-index: 50;
    line-height: 1;
  }
  .btt.visible { opacity: 1; transform: none; pointer-events: auto; }
  .btt:hover { color: var(--accent); border-color: var(--accent); }

  /* ── Footer ── */
  footer {
    text-align: center;
    padding: 2rem 1.5rem;
    font-size: 0.72rem;
    color: var(--muted);
    letter-spacing: 0.04em;
  }
  footer a {
    color: var(--secondary);
    text-decoration: none;
    border-bottom: 1px solid var(--border);
    transition: border-color 0.2s, color 0.2s;
  }
  footer a:hover { border-bottom-color: var(--accent); color: var(--accent); }

  /* ── Leaflet overrides ── */
  .leaflet-popup-content-wrapper {
    border-radius: var(--radius) !important;
    font-family: 'DM Sans', sans-serif !important;
    box-shadow: 0 3px 14px rgba(0,0,0,0.1) !important;
  }
  .leaflet-popup-content { margin: 10px 12px !important; font-size: 0.82rem; line-height: 1.45; }
  .leaflet-popup-content strong { font-weight: 500; }
  .leaflet-popup-content a { color: var(--accent); text-decoration: none; }

  /* ── Responsive ── */
  @media (max-width: 640px) {
    header { padding: 2.25rem 1.25rem 0; }
    .logo { font-size: 2.1rem; }
    .theme-toggle { top: 1rem; right: 1rem; }
    .controls { padding: 0.75rem 1.25rem; gap: 0.4rem; }
    .grid {
      grid-template-columns: 1fr;
      padding: 0 1.25rem 2rem;
    }
    .card { padding: 0.95rem 1.1rem; }
    .ms-drop { min-width: 200px; }
    #map-container { padding: 0 1.25rem 2rem; }
    #map-view { height: 55vh; }
  }
</style>
</head>
<body>

<a href="#grid" class="skip-link">Saltar al contenido</a>

<header>
  <div class="logo">Last Eat</div>
  <div class="stats" id="stats" aria-live="polite">Cargando...</div>
  <div class="divider"></div>
  <button class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema"></button>
</header>

<div class="controls-wrap">
  <div class="controls">
    <label class="sr-only" for="search">Buscar restaurantes</label>
    <input type="text" class="search-box" id="search" placeholder="Buscar restaurante, cocina, zona...">

    <div class="ms" id="ms-cuisine">
      <button class="ms-trigger" type="button" data-label="Cocina" aria-expanded="false" aria-haspopup="listbox">Cocina</button>
      <div class="ms-drop">
        <input class="ms-search" type="text" placeholder="Buscar cocina..." aria-label="Buscar cocina">
        <div class="ms-opts" role="listbox" aria-multiselectable="true"></div>
        <button class="ms-clear" type="button">Limpiar</button>
      </div>
    </div>

    <div class="ms" id="ms-district">
      <button class="ms-trigger" type="button" data-label="Zona" aria-expanded="false" aria-haspopup="listbox">Zona</button>
      <div class="ms-drop">
        <input class="ms-search" type="text" placeholder="Buscar zona..." aria-label="Buscar zona">
        <div class="ms-opts" role="listbox" aria-multiselectable="true"></div>
        <button class="ms-clear" type="button">Limpiar</button>
      </div>
    </div>

    <select id="price-filter" aria-label="Filtrar por precio">
      <option value="">Precio</option>
      <option value="0-30">Hasta 30 &euro;</option>
      <option value="0-50">Hasta 50 &euro;</option>
      <option value="0-80">Hasta 80 &euro;</option>
      <option value="80-999">Desde 80 &euro;</option>
    </select>

    <button class="ctrl-btn" id="fav-filter" type="button" aria-label="Favoritos" aria-pressed="false">&#9825;</button>
    <button class="ctrl-btn" id="geo-btn" type="button" aria-label="Cerca de m&iacute;" aria-pressed="false" title="Cerca de m&iacute;">&#8982;</button>

    <span class="sep"></span>

    <div class="btn-group" role="group" aria-label="Ordenar por">
      <button class="sort-btn active" data-sort="rating">Ranking</button>
      <button class="sort-btn" data-sort="name">A-Z</button>
      <button class="sort-btn" data-sort="price">Precio</button>
      <button class="sort-btn" data-sort="distance" id="sort-dist" hidden>Distancia</button>
    </div>

    <span class="sep"></span>

    <div class="btn-group" role="group" aria-label="Modo de vista">
      <button class="view-btn active" data-view="grid">Lista</button>
      <button class="view-btn" data-view="map">Mapa</button>
    </div>
  </div>
</div>

<div class="grid" id="grid"></div>

<div id="map-container" hidden>
  <div id="map-view"></div>
</div>

<button class="btt" id="btt" aria-label="Volver arriba">&uarr;</button>

<footer id="footer">
  Actualizado feb 2026
</footer>

<script src="app.js"></script>
<script src="data.js"></script>
<script>
(function() {
  'use strict';

  /* ── Constants ── */
  var BATCH = 60;
  var LEAFLET_CSS_INTEGRITY = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
  var LEAFLET_JS_INTEGRITY = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
  var app = window.LastEatApp;
  if (!app) throw new Error('LastEatApp module is required');

  /* ── DOM ── */
  var grid     = document.getElementById('grid');
  var searchEl = document.getElementById('search');
  var priceEl  = document.getElementById('price-filter');
  var statsEl  = document.getElementById('stats');
  var bttEl    = document.getElementById('btt');
  var favBtn   = document.getElementById('fav-filter');
  var mapCont  = document.getElementById('map-container');
  var geoBtn   = document.getElementById('geo-btn');
  var sortDistBtn = document.getElementById('sort-dist');

  /* ── Data Maps ── */
  var slugSet = new Set();
  var nameToSlug = Object.create(null);
  RESTAURANTS.forEach(function(r) {
    if (r && r.s) slugSet.add(r.s);
    if (r && r.n && r.s && !nameToSlug[r.n]) nameToSlug[r.n] = r.s;
  });

  /* ── State ── */
  var sort       = 'rating';
  var view       = 'grid';
  var favs       = new Set();
  var favsOnly   = false;
  var selCuisine = new Set();
  var selDistrict= new Set();
  var filtered   = [];
  var rendered   = 0;
  var map        = null;
  var tileLayer  = null;
  var markers    = [];
  var leafletOk  = false;
  var userLat    = null;
  var userLng    = null;
  var userMarker = null;

  /* ── Utilities ── */
  var esc = app.esc;
  var haversine = app.haversine;
  var formatDist = app.formatDist;
  function safeGetStorage(key) {
    try { return localStorage.getItem(key); } catch (_err) { return null; }
  }
  function safeSetStorage(key, value) {
    try { localStorage.setItem(key, value); } catch (_err) {}
  }
  function safeGetJSON(key, fallback) {
    var raw = safeGetStorage(key);
    if (!raw) return fallback;
    try { return JSON.parse(raw); } catch (_err) { return fallback; }
  }
  function safeHttpUrl(url) {
    if (!url || typeof url !== 'string') return '';
    try {
      var parsed = new URL(url, window.location.origin);
      if (parsed.protocol === 'http:' || parsed.protocol === 'https:') return parsed.href;
    } catch (_err) {}
    return '';
  }
  function getFavKey(r) {
    return (r && r.s) ? r.s : (r && r.n ? r.n : '');
  }
  function normalizeFavValue(value) {
    if (typeof value !== 'string' || !value) return '';
    if (slugSet.has(value)) return value;
    return nameToSlug[value] || '';
  }
  function loadFavs() {
    var raw = safeGetJSON('mf-fav', []);
    if (!Array.isArray(raw)) return;
    raw.forEach(function(item) {
      var key = normalizeFavValue(item);
      if (key) favs.add(key);
    });
  }

  /* ── Theme ── */
  function initTheme() {
    var saved = safeGetStorage('mf-theme');
    if (saved) { document.documentElement.dataset.theme = saved; return; }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.dataset.theme = 'dark';
    }
  }
  function toggleTheme() {
    var t = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = t;
    safeSetStorage('mf-theme', t);
    if (map && tileLayer) tileLayer.setUrl(getTileUrl());
  }
  function getTileUrl() {
    return document.documentElement.dataset.theme === 'dark'
      ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
      : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
  }

  /* ── Favorites ── */
  function saveFavs() { safeSetStorage('mf-fav', JSON.stringify(Array.from(favs))); }
  function toggleFav(favKey) {
    if (!favKey) return;
    if (favs.has(favKey)) favs.delete(favKey); else favs.add(favKey);
    saveFavs();
    /* Update visible hearts */
    grid.querySelectorAll('.fav-btn').forEach(function(b) {
      var key = b.getAttribute('data-fav-key');
      var active = favs.has(key);
      b.classList.toggle('active', active);
      b.textContent = active ? '\u2665' : '\u2661';
      b.setAttribute('aria-pressed', active ? 'true' : 'false');
    });
    updateFavBtn();
    if (favsOnly) render();
  }
  function updateFavBtn() {
    favBtn.textContent = (favsOnly ? '\u2665' : '\u2661') + (favs.size ? ' ' + favs.size : '');
    favBtn.classList.toggle('active', favsOnly);
    favBtn.setAttribute('aria-pressed', favsOnly ? 'true' : 'false');
  }
  loadFavs();

  /* ── Geolocation ── */
  function computeDistances() {
    if (userLat === null) return;
    RESTAURANTS.forEach(function(r) {
      if (r.lat && r.lng) {
        r._dist = haversine(userLat, userLng, parseFloat(r.lat), parseFloat(r.lng));
      } else {
        r._dist = 99999;
      }
    });
  }

  function activateGeo() {
    if (!navigator.geolocation) {
      geoBtn.title = 'Geolocalizaci\u00f3n no disponible';
      geoBtn.setAttribute('aria-pressed', 'false');
      return;
    }
    geoBtn.classList.add('loading');
    geoBtn.textContent = '\u2026';
    navigator.geolocation.getCurrentPosition(function(pos) {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;
      computeDistances();
      geoBtn.classList.remove('loading');
      geoBtn.classList.add('active');
      geoBtn.textContent = '\u2316';
      geoBtn.title = 'Desactivar ubicaci\u00f3n';
      geoBtn.setAttribute('aria-pressed', 'true');
      sortDistBtn.hidden = false;
      /* Auto-switch to distance sort */
      sort = 'distance';
      document.querySelectorAll('.sort-btn').forEach(function(b) {
        b.classList.toggle('active', b.getAttribute('data-sort') === 'distance');
      });
      render();
    }, function(err) {
      geoBtn.classList.remove('loading');
      geoBtn.textContent = '\u2316';
      if (err.code === 1) {
        geoBtn.title = 'Permiso de ubicaci\u00f3n denegado';
      } else {
        geoBtn.title = 'No se pudo obtener la ubicaci\u00f3n';
      }
      geoBtn.setAttribute('aria-pressed', 'false');
    }, { enableHighAccuracy: false, timeout: 15000, maximumAge: 300000 });
  }

  function deactivateGeo() {
    userLat = null;
    userLng = null;
    RESTAURANTS.forEach(function(r) { delete r._dist; });
    geoBtn.classList.remove('active');
    geoBtn.textContent = '\u2316';
    geoBtn.title = 'Cerca de m\u00ed';
    geoBtn.setAttribute('aria-pressed', 'false');
    sortDistBtn.hidden = true;
    if (userMarker && map) { userMarker.remove(); userMarker = null; }
    if (sort === 'distance') {
      sort = 'rating';
      document.querySelectorAll('.sort-btn').forEach(function(b) {
        b.classList.toggle('active', b.getAttribute('data-sort') === 'rating');
      });
    }
    render();
  }

  geoBtn.addEventListener('click', function() {
    if (userLat !== null) deactivateGeo();
    else activateGeo();
  });

  /* ── Multi-Select ── */
  function setupMS(id, items, onChange) {
    var el      = document.getElementById(id);
    var trigger = el.querySelector('.ms-trigger');
    var search  = el.querySelector('.ms-search');
    var opts    = el.querySelector('.ms-opts');
    var clear   = el.querySelector('.ms-clear');
    var label   = trigger.getAttribute('data-label');
    var activeLabel = null;
    var listboxId = id + '-listbox';
    opts.id = listboxId;
    trigger.setAttribute('aria-controls', listboxId);

    function closeDropdown(focusTrigger) {
      el.classList.remove('open');
      trigger.setAttribute('aria-expanded', 'false');
      if (activeLabel) {
        activeLabel.classList.remove('active');
        activeLabel = null;
      }
      if (focusTrigger) trigger.focus();
    }

    function openDropdown() {
      document.querySelectorAll('.ms.open').forEach(function(m) {
        if (m !== el) {
          m.classList.remove('open');
          var otherTrigger = m.querySelector('.ms-trigger');
          if (otherTrigger) otherTrigger.setAttribute('aria-expanded', 'false');
        }
      });
      el.classList.add('open');
      trigger.setAttribute('aria-expanded', 'true');
      search.focus();
    }

    function visibleLabels() {
      return [].slice.call(opts.querySelectorAll('label')).filter(function(l) { return !l.hidden; });
    }

    function setActiveLabel(nextLabel) {
      if (activeLabel) activeLabel.classList.remove('active');
      activeLabel = nextLabel || null;
      if (activeLabel) activeLabel.classList.add('active');
    }

    function focusByStep(step) {
      var labels = visibleLabels();
      if (!labels.length) return;
      var current = document.activeElement && document.activeElement.closest('label');
      var idx = labels.indexOf(current);
      var nextIdx = idx + step;
      if (idx === -1) nextIdx = step > 0 ? 0 : labels.length - 1;
      if (nextIdx < 0) nextIdx = labels.length - 1;
      if (nextIdx >= labels.length) nextIdx = 0;
      var next = labels[nextIdx].querySelector('input');
      if (next) {
        next.focus();
        setActiveLabel(labels[nextIdx]);
      }
    }

    items.forEach(function(item) {
      var lbl = document.createElement('label');
      var cb  = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = item;
      lbl.setAttribute('role', 'option');
      lbl.setAttribute('aria-selected', 'false');
      lbl.appendChild(cb);
      lbl.appendChild(document.createTextNode(item));
      opts.appendChild(lbl);
      cb.addEventListener('change', function() {
        lbl.setAttribute('aria-selected', cb.checked ? 'true' : 'false');
        sync();
        onChange(getSelected());
      });
    });

    el.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    trigger.addEventListener('click', function(e) {
      e.stopPropagation();
      if (el.classList.contains('open')) closeDropdown(false);
      else openDropdown();
    });

    trigger.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (!el.classList.contains('open')) openDropdown();
        focusByStep(e.key === 'ArrowDown' ? 1 : -1);
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDropdown(true);
      }
    });

    search.addEventListener('input', function() {
      var q = search.value.toLowerCase();
      opts.querySelectorAll('label').forEach(function(l) {
        l.hidden = l.textContent.toLowerCase().indexOf(q) === -1;
      });
      setActiveLabel(null);
    });

    search.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDropdown(true);
      }
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        focusByStep(e.key === 'ArrowDown' ? 1 : -1);
      }
    });

    clear.addEventListener('click', function() {
      opts.querySelectorAll('input').forEach(function(cb) {
        cb.checked = false;
        var row = cb.closest('label');
        if (row) row.setAttribute('aria-selected', 'false');
      });
      sync();
      onChange(getSelected());
    });

    opts.addEventListener('focusin', function(e) {
      var row = e.target.closest('label');
      if (row) setActiveLabel(row);
    });

    opts.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDropdown(true);
        return;
      }
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        focusByStep(e.key === 'ArrowDown' ? 1 : -1);
        return;
      }
      if (e.key === 'Enter' && e.target && e.target.matches('input[type=\"checkbox\"]')) {
        e.preventDefault();
        e.target.checked = !e.target.checked;
        sync();
        onChange(getSelected());
      }
    });

    function getSelected() {
      return [].slice.call(opts.querySelectorAll('input:checked')).map(function(cb) { return cb.value; });
    }
    function sync() {
      var sel = getSelected();
      var hasSel = sel.length > 0;
      el.classList.toggle('has-sel', hasSel);
      trigger.textContent = hasSel ? label + ' (' + sel.length + ')' : label;
    }
    return {
      setSelected: function(vals) {
        var set = new Set(vals);
        opts.querySelectorAll('input').forEach(function(cb) {
          cb.checked = set.has(cb.value);
          var row = cb.closest('label');
          if (row) row.setAttribute('aria-selected', cb.checked ? 'true' : 'false');
        });
        sync();
      },
      getSelected: getSelected,
      close: function() { closeDropdown(false); }
    };
  }

  /* Build options */
  var cuisineSet = new Set();
  RESTAURANTS.forEach(function(r) {
    if (r.c) r.c.split('\u2022').forEach(function(t) {
      var trimmed = t.trim();
      if (trimmed) cuisineSet.add(trimmed);
    });
  });
  var cuisineOpts  = [].slice.call(cuisineSet).sort(function(a,b){ return a.localeCompare(b,'es'); });
  var districtOpts = [].slice.call(new Set(RESTAURANTS.map(function(r){return r.d;}).filter(Boolean))).sort(function(a,b){ return a.localeCompare(b,'es'); });

  var cuisineMS  = setupMS('ms-cuisine', cuisineOpts, function(sel) { selCuisine = new Set(sel); render(); });
  var districtMS = setupMS('ms-district', districtOpts, function(sel) { selDistrict = new Set(sel); render(); });

  /* Close dropdowns on outside click */
  document.addEventListener('click', function() {
    cuisineMS.close();
    districtMS.close();
  });
  document.addEventListener('keydown', function(e) {
    if (e.key !== 'Escape') return;
    cuisineMS.close();
    districtMS.close();
  });

  /* ── URL State ── */
  function syncURL() {
    var p = new URLSearchParams();
    if (searchEl.value.trim()) p.set('q', searchEl.value.trim());
    if (selCuisine.size) [].slice.call(selCuisine).forEach(function(c) { p.append('c', c); });
    if (selDistrict.size) [].slice.call(selDistrict).forEach(function(d) { p.append('d', d); });
    if (priceEl.value)    p.set('p', priceEl.value);
    if (sort !== 'rating') p.set('s', sort);
    if (favsOnly) p.set('f', '1');
    var qs = p.toString();
    history.replaceState(null, '', qs ? '?' + qs : location.pathname);
  }
  function readURL() {
    var p = new URLSearchParams(location.search);
    if (p.has('q')) searchEl.value = p.get('q');
    var v = p.getAll('c');
    if (v.length === 1 && v[0].indexOf(',') !== -1) v = v[0].split(',');
    if (v.length) { selCuisine = new Set(v); cuisineMS.setSelected(v); }
    var v2 = p.getAll('d');
    if (v2.length === 1 && v2[0].indexOf(',') !== -1) v2 = v2[0].split(',');
    if (v2.length) { selDistrict = new Set(v2); districtMS.setSelected(v2); }
    if (p.has('p')) priceEl.value = p.get('p');
    if (p.has('s')) {
      sort = p.get('s');
      document.querySelectorAll('.sort-btn').forEach(function(b) {
        b.classList.toggle('active', b.getAttribute('data-sort') === sort);
      });
    }
    if (p.get('f') === '1') favsOnly = true;
  }

  /* ── Filter & Sort ── */
  function getFiltered() {
    return app.getFiltered(RESTAURANTS, {
      query: searchEl.value,
      priceValue: priceEl.value,
      selCuisine: selCuisine,
      selDistrict: selDistrict,
      favsOnly: favsOnly,
      favs: favs,
      sort: sort,
      getFavKey: getFavKey,
    });
  }

  /* ── Card Builder ── */
  function buildCard(r) {
    var favKey = getFavKey(r);
    var isFav  = favs.has(favKey);
    var heart  = isFav ? '\u2665' : '\u2661';
    var favCls = isFav ? ' active' : '';
    var rCls   = r.r && r.r !== '-' ? '' : ' no-r';
    var rText  = r.r && r.r !== '-' ? r.r : '\u2014';
    var tags   = r.c ? r.c.split(/[\u2022,]/).map(function(t) {
      return '<span class="tag">' + esc(t.trim()) + '</span>';
    }).join('') : '';
    var price  = r.p ? r.p + ' \u20ac' : '';
    var gmaps  = 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent((r.n || '') + ', ' + (r.a || ''));
    var websiteUrl = safeHttpUrl(r.w);
    var sourceUrl = safeHttpUrl(r.u || (r.s ? ('https://macarfi.com/es/mad/ficha-restaurante/' + encodeURIComponent(r.s)) : ''));
    var pageUrl = r.s ? '/r/' + encodeURIComponent(r.s) + '.html' : sourceUrl;
    if (!pageUrl) pageUrl = '#';
    var eName  = esc(r.n);
    var eFavKey = esc(favKey);

    /* Expandable detail */
    var rDetail = [
      r.rf ? 'Comida <strong>' + esc(r.rf) + '</strong>' : '',
      r.rd ? 'Decor <strong>' + esc(r.rd) + '</strong>' : '',
      r.rs ? 'Servicio <strong>' + esc(r.rs) + '</strong>' : ''
    ].filter(Boolean).join(' \u00b7 ');
    var phoneValue = r.ph ? String(r.ph).replace(/\s/g,'') : '';
    var phone = phoneValue ? '<div class="card-phone"><a href="tel:' + esc(phoneValue) + '">' + esc(r.ph) + '</a></div>' : '';
    var addr  = r.a ? '<div class="card-address">' + esc(r.a) + '</div>' : '';
    var hasDetail = rDetail || r.ph || r.a;

    return '<div class="card" tabindex="0" role="article">' +
      '<div class="card-top">' +
        '<div class="card-name"><a href="' + pageUrl + '">' + eName + '</a></div>' +
        '<button class="fav-btn' + favCls + '" data-fav-key="' + eFavKey + '" aria-label="Favorito" aria-pressed="' + (isFav ? 'true' : 'false') + '">' + heart + '</button>' +
        '<div class="card-rating' + rCls + '">' + esc(rText) + '</div>' +
      '</div>' +
      '<div class="card-meta">' +
        (r.d ? '<span>' + esc(r.d) + '</span>' : '') +
        (price ? '<span>' + esc(price) + '</span>' : '') +
        (r._dist != null ? '<span class="card-dist">' + formatDist(r._dist) + '</span>' : '') +
      '</div>' +
      (tags ? '<div class="card-tags">' + tags + '</div>' : '') +
      (hasDetail ? '<div class="card-expand"><div>' +
        '<div class="card-detail">' +
          (rDetail ? '<div class="card-ratings">' + rDetail + '</div>' : '') +
          addr + phone +
        '</div>' +
      '</div></div>' : '') +
      '<div class="card-actions">' +
        '<a href="' + gmaps + '" target="_blank" rel="noopener noreferrer">Maps</a>' +
        (websiteUrl ? '<a href="' + websiteUrl + '" target="_blank" rel="noopener noreferrer">Web</a>' : '') +
        (sourceUrl ? '<a href="' + sourceUrl + '" target="_blank" rel="noopener noreferrer">Fuente</a>' : '') +
      '</div>' +
    '</div>';
  }

  /* ── Progressive Rendering ── */
  var sentinel = document.createElement('div');
  sentinel.className = 'sentinel';
  var observer = new IntersectionObserver(function(entries) {
    if (entries[0] && entries[0].isIntersecting && rendered < filtered.length) {
      observer.unobserve(sentinel);
      renderBatch();
    }
  }, { rootMargin: '300px' });

  function renderBatch() {
    var batch = filtered.slice(rendered, rendered + BATCH);
    if (!batch.length) return;
    if (sentinel.parentNode) sentinel.remove();
    grid.insertAdjacentHTML('beforeend', batch.map(buildCard).join(''));
    rendered += batch.length;
    if (rendered < filtered.length) {
      grid.appendChild(sentinel);
      observer.observe(sentinel);
    }
  }

  function render() {
    observer.disconnect();
    if (sentinel.parentNode) sentinel.remove();
    filtered = getFiltered();
    statsEl.textContent = filtered.length + ' de ' + RESTAURANTS.length + ' restaurantes';
    grid.innerHTML = '';
    rendered = 0;
    if (!filtered.length) {
      grid.innerHTML = '<div class="no-results">No se encontraron restaurantes con esos filtros.</div>';
    } else {
      renderBatch();
    }
    syncURL();
    if (view === 'map' && leafletOk) updateMap();
  }

  /* ── Map ── */
  function loadLeaflet() {
    return new Promise(function(resolve) {
      if (leafletOk) { resolve(); return; }
      var css = document.createElement('link');
      css.rel = 'stylesheet';
      css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      css.integrity = LEAFLET_CSS_INTEGRITY;
      css.crossOrigin = 'anonymous';
      document.head.appendChild(css);
      var js = document.createElement('script');
      js.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      js.integrity = LEAFLET_JS_INTEGRITY;
      js.crossOrigin = 'anonymous';
      js.onload = function() { leafletOk = true; resolve(); };
      document.head.appendChild(js);
    });
  }
  function initMap() {
    mapCont.hidden = false;
    grid.style.display = 'none';
    if (map) { updateMap(); map.invalidateSize(); return; }
    loadLeaflet().then(function() {
      map = L.map('map-view').setView([40.42, -3.7], 13);
      tileLayer = L.tileLayer(getTileUrl(), { attribution: '&copy; OpenStreetMap &copy; CartoDB' }).addTo(map);
      updateMap();
    });
  }
  function updateMap() {
    if (!map) return;
    markers.forEach(function(m) { m.remove(); });
    markers = [];
    var accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
    filtered.forEach(function(r) {
      if (!r.lat || !r.lng) return;
      var popup = '<strong>' + esc(r.n) + '</strong>';
      if (r.r && r.r !== '-') popup += '<br>' + esc(r.r) + '/10';
      if (r.d) popup += '<br>' + esc(r.d);
      if (r._dist != null) popup += '<br>' + formatDist(r._dist);
      if (r.s) popup += '<br><a href="/r/' + encodeURIComponent(r.s) + '.html">Ver m\u00e1s</a>';
      var m = L.circleMarker([parseFloat(r.lat), parseFloat(r.lng)], {
        radius: 5, fillColor: accent, fillOpacity: 0.85, color: '#fff', weight: 1.5
      }).bindPopup(popup);
      m.addTo(map);
      markers.push(m);
    });
    /* User position marker */
    if (userMarker) { userMarker.remove(); userMarker = null; }
    if (userLat !== null) {
      userMarker = L.circleMarker([userLat, userLng], {
        radius: 8, fillColor: '#3B82F6', fillOpacity: 1, color: '#fff', weight: 2.5
      }).bindPopup('Tu ubicaci\u00f3n').addTo(map);
      markers.push(userMarker);
    }
    /* Fit bounds if markers exist */
    if (markers.length) {
      var group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.1));
    }
  }
  function showGrid() {
    mapCont.hidden = true;
    grid.style.display = '';
    view = 'grid';
  }

  /* ── Back to Top ── */
  var scrollTick = false;
  window.addEventListener('scroll', function() {
    if (!scrollTick) {
      requestAnimationFrame(function() {
        bttEl.classList.toggle('visible', window.scrollY > 500);
        scrollTick = false;
      });
      scrollTick = true;
    }
  });
  bttEl.addEventListener('click', function() { window.scrollTo({ top: 0, behavior: 'smooth' }); });

  /* ── Card interactions (delegated) ── */
  grid.addEventListener('click', function(e) {
    /* Favorite toggle */
    var fb = e.target.closest('.fav-btn');
    if (fb) { e.stopPropagation(); toggleFav(fb.getAttribute('data-fav-key')); return; }
    /* Links pass through */
    if (e.target.closest('a')) return;
    /* Expand/collapse */
    var card = e.target.closest('.card');
    if (card) card.classList.toggle('expanded');
  });
  grid.addEventListener('keydown', function(e) {
    if (e.key !== 'Enter' && e.key !== ' ') return;
    var card = e.target.closest('.card');
    if (!card) return;
    if (e.target.closest('a') || e.target.closest('.fav-btn')) return;
    e.preventDefault();
    card.classList.toggle('expanded');
  });

  /* ── Event Listeners ── */
  var searchTimer;
  searchEl.addEventListener('input', function() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(render, 150);
  });
  priceEl.addEventListener('change', render);

  document.querySelectorAll('.sort-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.sort-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      sort = btn.getAttribute('data-sort');
      render();
    });
  });

  document.querySelectorAll('.view-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.view-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      var v = btn.getAttribute('data-view');
      if (v === 'map') { view = 'map'; initMap(); }
      else showGrid();
    });
  });

  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

  favBtn.addEventListener('click', function() {
    favsOnly = !favsOnly;
    updateFavBtn();
    render();
  });

  /* ── Dynamic footer ── */
  function updateFooter() {
    if (typeof META === 'undefined') return;
    var d = new Date(META.updated);
    if (isNaN(d)) return;
    var months = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'];
    document.getElementById('footer').textContent =
      'Actualizado ' + months[d.getMonth()] + ' ' + d.getFullYear();
  }

  /* ── Init ── */
  initTheme();
  readURL();
  updateFavBtn();
  updateFooter();
  render();
})();

/* ── Service Worker ── */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js');
}
</script>
</body>
</html>
